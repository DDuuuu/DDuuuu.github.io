<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>DotNet基础 线程 - AndrewDu&#39;s blog</title><meta name="author" content="AndrewDu">
<meta name="author-link" content="https://github.com/DDuuuu">
<meta name="description" content="多线程和异步函数 当异步线程在工作完成时如何通知调用线程 当异步线程出现异常的时候该如何处理 异步线程工作的进度如何实时的通知调用线程 如何在调用线" /><meta name="keywords" content='DotNet基础, 线程' />
  <meta itemprop="name" content="DotNet基础 线程">
  <meta itemprop="description" content="多线程和异步函数 当异步线程在工作完成时如何通知调用线程 当异步线程出现异常的时候该如何处理 异步线程工作的进度如何实时的通知调用线程 如何在调用线">
  <meta itemprop="datePublished" content="2018-11-23T17:09:22+08:00">
  <meta itemprop="dateModified" content="2018-11-23T17:09:22+08:00">
  <meta itemprop="wordCount" content="26818">
  <meta itemprop="image" content="https://DDuuuu.github.io/images/logo150.png">
  <meta itemprop="keywords" content="DotNet基础,线程"><meta property="og:url" content="https://DDuuuu.github.io/2018/11/dotnetbase4-thread/">
  <meta property="og:site_name" content="AndrewDu&#39;s blog">
  <meta property="og:title" content="DotNet基础 线程">
  <meta property="og:description" content="多线程和异步函数 当异步线程在工作完成时如何通知调用线程 当异步线程出现异常的时候该如何处理 异步线程工作的进度如何实时的通知调用线程 如何在调用线">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-11-23T17:09:22+08:00">
    <meta property="article:modified_time" content="2018-11-23T17:09:22+08:00">
    <meta property="article:tag" content="DotNet基础">
    <meta property="article:tag" content="线程">
    <meta property="og:image" content="https://DDuuuu.github.io/images/logo150.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://DDuuuu.github.io/images/logo150.png">
  <meta name="twitter:title" content="DotNet基础 线程">
  <meta name="twitter:description" content="多线程和异步函数 当异步线程在工作完成时如何通知调用线程 当异步线程出现异常的时候该如何处理 异步线程工作的进度如何实时的通知调用线程 如何在调用线">
<meta name="application-name" content="Andrew.Du">
<meta name="apple-mobile-web-app-title" content="Andrew.Du"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://DDuuuu.github.io/2018/11/dotnetbase4-thread/" /><link rel="prev" href="https://DDuuuu.github.io/2018/11/dotnetbase2-sql-adonet/" /><link rel="next" href="https://DDuuuu.github.io/2018/12/dotnetbase5-winform/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "DotNet基础 线程",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/DDuuuu.github.io\/2018\/11\/dotnetbase4-thread\/"
    },"image": ["https:\/\/DDuuuu.github.io\/images\/logo192.png"],"genre": "posts","keywords": "DotNet基础, 线程","wordcount":  26818 ,
    "url": "https:\/\/DDuuuu.github.io\/2018\/11\/dotnetbase4-thread\/","datePublished": "2018-11-23T17:09:22+08:00","dateModified": "2018-11-23T17:09:22+08:00","license": "Copyright© Andrew.Du","publisher": {
      "@type": "Organization",
      "name": "AndrewDu"},"author": {
        "@type": "Person",
        "name": "AndrewDu"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="AndrewDu&#39;s blog"><span class="typeit"><template>AndrewDu&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/"
                title="主页"
                
              ><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden="true"></i> 主页</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/archives/"
                title="归档"
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 类别</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="AndrewDu&#39;s blog"><span class="typeit"><template>AndrewDu&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/"
                  title="主页"
                  
                ><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden="true"></i> 主页</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/archives/"
                  title="归档"
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 类别</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="AndrewDu&#39;s Blog">主页</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">文章</a></li><li class="breadcrumb-item active" aria-current="page">DotNet基础 线程</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>DotNet基础 线程</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/DDuuuu" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
    AndrewDu</a></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/dotnet%E5%9F%BA%E7%A1%80/" class="post-category" title="分类 - DotNet基础"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> DotNet基础</a></span></div><div class="post-meta-line"><span title="发布于 2018-11-23 17:09:22"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2018-11-23">2018-11-23</time></span>&nbsp;<span title="26818 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 26900 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 54 分钟</span>&nbsp;<span class="comment-visitors" data-flag-title="DotNet基础 线程">
              <i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span class="artalk-visitor-count" data-page-key="/2018/11/dotnetbase4-thread/">-</span>&nbsp;次阅读
            </span>&nbsp;<span class="comment-count" data-flag-title="DotNet基础 线程">
              <i class="fa-regular fa-comments fa-fw me-1" aria-hidden="true"></i><span class="artalk-comment-count" data-page-key="/2018/11/dotnetbase4-thread/">-</span>&nbsp;条评论
            </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#多线程和异步函数">多线程和异步函数</a>
      <ul>
        <li><a href="#异步函数模型">异步函数模型</a></li>
        <li><a href="#自动通知主线程完成">自动通知主线程完成</a></li>
      </ul>
    </li>
    <li><a href="#正常的线程调用">正常的线程调用</a>
      <ul>
        <li><a href="#thread类">Thread类</a></li>
      </ul>
    </li>
    <li><a href="#带参数的线程">带参数的线程</a></li>
    <li><a href="#两个线程参数不一样">两个线程参数不一样</a></li>
    <li><a href="#传递多参数">传递多参数</a></li>
    <li><a href="#多线程同干一件事">多线程同干一件事</a>
      <ul>
        <li><a href="#上下文同步策略">上下文同步策略</a></li>
        <li><a href="#同步代码区">同步代码区</a></li>
        <li><a href="#手动同步">手动同步</a></li>
        <li><a href="#autoresetevent-类">AutoResetEvent 类</a></li>
        <li><a href="#manualresetevent-类">ManualResetEvent 类</a></li>
        <li><a href="#interlocked-类">Interlocked 类</a></li>
        <li><a href="#waithandle">waithandle</a></li>
        <li><a href="#线程池">线程池</a></li>
      </ul>
    </li>
    <li><a href="#ui界面卡顿的问题">UI界面卡顿的问题</a></li>
    <li><a href="#task类">Task类</a>
      <ul>
        <li><a href="#多线程ui的例子">多线程UI的例子</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="感谢阅读！"><h2 id="多线程和异步函数" class="heading-element"><span>多线程和异步函数</span>
  <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%92%8c%e5%bc%82%e6%ad%a5%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li><strong>当异步线程在工作完成时如何通知调用线程</strong></li>
<li><strong>当异步线程出现异常的时候该如何处理</strong></li>
<li><strong>异步线程工作的进度如何实时的通知调用线程</strong></li>
<li><strong>如何在调用线程中取消正在工作的异步线程，并进行回滚操作</strong></li>
</ul>
<h3 id="异步函数模型" class="heading-element"><span>异步函数模型</span>
  <a href="#%e5%bc%82%e6%ad%a5%e5%87%bd%e6%95%b0%e6%a8%a1%e5%9e%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>异步函数编程模式，<strong>只要是使用委托对象封装的函数都可以实现该函数的异步调用</strong>。因为委托类型有BeginInvoke和EndInvoke这两个方法来支持异步调用。</p>
<ul>
<li>BeginInvoke无参数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">DoWork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">WorkPro</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">结果</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>BeginInvoke有参数，
<ul>
<li>BeginInvoke，IAsyncResult ，EndInvoke，使用这三个函数会等，<strong>异步调用EndInvoke返回</strong>再开启主线程，异步调用时间比主线程长，主线程会处于阻塞状态，阻塞位置在EndInvoke函数</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IAsyncResult</span> <span class="n">r</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">EndInvoke</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn result:{result}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WorkPro</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">result</span><span class="p">:</span><span class="m">45</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当调整EndInvoke的位置时，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IAsyncResult</span> <span class="n">r</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">EndInvoke</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn result:{result}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WorkPro</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">result</span><span class="p">:</span><span class="m">45</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>主线程执行时间比异步调用的长，并未看见阻塞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IAsyncResult</span> <span class="n">r</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">EndInvoke</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn result:{result}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WorkPro</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">result</span><span class="p">:</span><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="自动通知主线程完成" class="heading-element"><span>自动通知主线程完成</span>
  <a href="#%e8%87%aa%e5%8a%a8%e9%80%9a%e7%9f%a5%e4%b8%bb%e7%ba%bf%e7%a8%8b%e5%ae%8c%e6%88%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>上面两个例子这并不是理想的状态，理想状态是，异步调用完成后自动通知主线程完成，主线程调用。</p>
<p>BeginInvoke 方法启动异步调用。<strong>该方法具有与你要异步执行的方法相同的参数，另加两个可选参数</strong>。 第一个参数是一个 AsyncCallback 委托，此委托引用在异步调用完成时要调用的方法。 第二个参数是一个用户定义的对象object，该对象将信息传递到回调方法。</p>
<p>BeginInvoke 将立即返回，而不会等待异步调用完成。 BeginInvoke 返回可用于监视异步调用的进度的 IAsyncResult。</p>
<p>EndInvoke 方法用于检索异步调用的结果。 它可以在调用 BeginInvoke之后的任意时间调用。 如果异步调用尚未完成，那么 EndInvoke 将阻止调用线程，直到完成异步调用。 EndInvoke 的参数包括要异步执行的方法的 out 和 ref 参数，以及 BeginInvoke 返回的 IAsyncResult。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IAsyncResult</span> <span class="n">r</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">CallBack</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WorkPro</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">CallBack</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="p">(</span><span class="n">DoWork</span><span class="p">)</span><span class="n">r</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn result:{d.EndInvoke(r)}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">result</span><span class="p">:</span><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>改进查看CallBack的执行情况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DoWork</span><span class="p">(</span><span class="n">WorkPro</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">IAsyncResult</span> <span class="n">r</span> <span class="p">=</span> <span class="n">d</span><span class="p">.</span><span class="n">BeginInvoke</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">CallBack</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">WorkPro</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">CallBack</span><span class="p">(</span><span class="n">IAsyncResult</span> <span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;CallBack: {i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">DoWork</span> <span class="n">d</span> <span class="p">=</span> <span class="p">(</span><span class="n">DoWork</span><span class="p">)</span><span class="n">r</span><span class="p">.</span><span class="n">AsyncState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn result:{d.EndInvoke(r)}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">CallBack</span><span class="p">:</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">CallBack</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">CallBack</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span> <span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">CallBack</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">CallBack</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">result</span><span class="p">:</span><span class="m">10</span></span></span></code></pre></td></tr></table>
</div>
</div><p>回调函数也处于另一个线程中，与主线程并行执行，并且执行时间不等</p>
<h2 id="正常的线程调用" class="heading-element"><span>正常的线程调用</span>
  <a href="#%e6%ad%a3%e5%b8%b8%e7%9a%84%e7%ba%bf%e7%a8%8b%e8%b0%83%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>.net在System.Threading和System.Threading.Tasks这两个命名空间中提供了Thread，ThreadPool，和Task三个类来处理多线程的问题，其中Thread是建立一个专用线程，ThreadPool是使用线程池中工作线程，而Task类是采用任务的方式，其内部也是使用线程池中的工作线程。</p>
<h3 id="thread类" class="heading-element"><span>Thread类</span>
  <a href="#thread%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>使用方法很简单，它开辟的是一个专用线程，不是线程池中的工作线程，不由线程池去管理。该类提供4个重载版本，常见的使用前面两个就好了。
<ul>
<li><code>public Thread( ThreadStart start )</code>：其中ThreadStart是一个无参无返回值的委托类型。</li>
<li><code>public Thread( ParameterizedThreadStart start )</code>：其中ParameterizedThreadStart 是一个带有一个Object类型的参数，无返回值的委托类型。</li>
</ul>
</li>
</ul>
<p>从Thread类提供了两个构造函数可以看出，Thread类能够异步调用无参无返回值的函数，也能够异步调用带一个Object类型的无返回值的函数。下面就给出一个例子简单的演示一下如何使用Thread异步执行一个带参数的函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">Program</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">interval</span> <span class="p">=</span> <span class="m">200</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">Program</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Program</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">			<span class="n">Thread</span> <span class="n">nonParameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">NonParameterRun</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">			<span class="n">nonParameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 不带参数的启动方法  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="k">void</span> <span class="n">NonParameterRun</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">			<span class="p">{</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;系统当前时间毫秒值：&#34;</span><span class="p">+</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">);</span><span class="c1">//让线程暂停  </span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">384</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">591</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">792</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">993</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">194</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">394</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">595</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">796</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">997</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">198</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="带参数的线程" class="heading-element"><span>带参数的线程</span>
  <a href="#%e5%b8%a6%e5%8f%82%e6%95%b0%e7%9a%84%e7%ba%bf%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>线程输出10个值后就终止执行了，用ThreadStart委托作为构造函数来实例化thread是不带参数的，带参数的委托ParameterizedThreadStart，<strong>其带有一个Object参数的方法</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">interval</span> <span class="p">=</span> <span class="m">200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Program</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Program</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">parameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ParameterRun</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">parameterThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread A:&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">parameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// 带参数的启动方法  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;param name=&#34;ms&#34;&gt;让线程在运行过程中的休眠间隔&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">ParameterRun</span><span class="p">(</span><span class="kt">object</span> <span class="n">ms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="n">ms</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="k">out</span> <span class="n">j</span><span class="p">);</span><span class="c1">//这里采用了TryParse方法，避免不能转换时出现异常  </span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&#34;系统当前时间毫秒值：&#34;</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="c1">//让线程暂停  </span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">127</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">136</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">142</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">148</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">154</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span>  </span></span></code></pre></td></tr></table>
</div>
</div><h2 id="两个线程参数不一样" class="heading-element"><span>两个线程参数不一样</span>
  <a href="#%e4%b8%a4%e4%b8%aa%e7%ba%bf%e7%a8%8b%e5%8f%82%e6%95%b0%e4%b8%8d%e4%b8%80%e6%a0%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>第一个线程启动后，线程实例就不需要存在了</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="err">两个线程间隔时间不一样</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">Program</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">interval</span> <span class="p">=</span> <span class="m">200</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">Program</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Program</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">			<span class="n">Thread</span> <span class="n">parameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ParameterRun</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread A:&#34;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="m">30</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">			<span class="c1">//启动第二个线程  </span>
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ParameterRun</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread B:&#34;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="m">60</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 带参数的启动方法  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;ms&#34;&gt;让线程在运行过程中的休眠间隔&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="k">void</span> <span class="n">ParameterRun</span><span class="p">(</span><span class="kt">object</span> <span class="n">ms</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="kt">int</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="n">ms</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="k">out</span> <span class="n">j</span><span class="p">);</span><span class="c1">//这里采用了TryParse方法，避免不能转换时出现异常  </span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">			<span class="p">{</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">+</span><span class="s">&#34;系统当前时间毫秒值：&#34;</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">j</span><span class="p">);</span><span class="c1">//让线程暂停  </span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">294</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">294</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">326</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">357</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">357</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">388</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">418</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">419</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">450</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">479</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">481</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">511</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">540</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">543</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">574</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">600</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">661</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">723</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">784</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">B</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">845</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="传递多参数" class="heading-element"><span>传递多参数</span>
  <a href="#%e4%bc%a0%e9%80%92%e5%a4%9a%e5%8f%82%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>如果需要传递两个参数怎么办呢，有两种方法
<ul>
<li>调用ParameterizedThreadStart，将参数封装成类，或者结构进行调用</li>
<li>构造线程类，将自己的线程和参数封装在一起</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">MyThreadParameter</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kt">int</span> <span class="n">loopCount</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 循环次数  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="kt">int</span> <span class="n">LoopCount</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">loopCount</span><span class="p">;</span> <span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 线程的暂停间隔  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="kt">int</span> <span class="n">Interval</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">interval</span><span class="p">;</span> <span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 构造函数  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;interval&#34;&gt;线程的暂停间隔&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;loopCount&#34;&gt;循环次数&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="n">MyThreadParameter</span><span class="p">(</span><span class="kt">int</span> <span class="n">interval</span><span class="p">,</span><span class="kt">int</span> <span class="n">loopCount</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="p">.</span><span class="n">interval</span> <span class="p">=</span> <span class="n">interval</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="p">.</span><span class="n">loopCount</span> <span class="p">=</span> <span class="n">loopCount</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">Program</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">interval</span> <span class="p">=</span> <span class="m">200</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">Program</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Program</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">			<span class="n">Thread</span> <span class="n">parameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">MyParameterRun</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread A:&#34;</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="n">MyThreadParameter</span> <span class="n">paramter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyThreadParameter</span><span class="p">(</span><span class="m">50</span><span class="p">,</span> <span class="m">5</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">paramter</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// 带多个参数的启动方法  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;ms&#34;&gt;方法参数&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="k">void</span> <span class="n">MyParameterRun</span><span class="p">(</span><span class="kt">object</span> <span class="n">ms</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">MyThreadParameter</span> <span class="n">parameter</span> <span class="p">=</span> <span class="n">ms</span> <span class="k">as</span> <span class="n">MyThreadParameter</span><span class="p">;</span><span class="c1">//类型转换  </span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">parameter</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">			<span class="p">{</span>  
</span></span><span class="line"><span class="cl">				<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">parameter</span><span class="p">.</span><span class="n">LoopCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">				<span class="p">{</span>  
</span></span><span class="line"><span class="cl">					<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&#34;系统当前时间毫秒值：&#34;</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">					<span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">parameter</span><span class="p">.</span><span class="n">Interval</span><span class="p">);</span><span class="c1">//让线程暂停  </span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>  
</span></span><span class="line"><span class="cl">			<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">215</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">270</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">321</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">372</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread</span> <span class="n">A</span><span class="p">:</span><span class="err">系统当前时间毫秒值：</span><span class="m">423</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">MyThreadParameter</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kt">int</span> <span class="n">loopCount</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="n">Thread</span> <span class="n">thread</span><span class="p">;</span>  	  
</span></span><span class="line"><span class="cl">	<span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">	<span class="cs">/// 构造函数  </span>
</span></span><span class="line"><span class="cl">	<span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;interval&#34;&gt;线程的暂停间隔&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="cs">/// &lt;param name=&#34;loopCount&#34;&gt;循环次数&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="n">MyThreadParameter</span><span class="p">(</span><span class="kt">int</span> <span class="n">interval</span><span class="p">,</span><span class="kt">int</span> <span class="n">loopCount</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="p">.</span><span class="n">interval</span> <span class="p">=</span> <span class="n">interval</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="k">this</span><span class="p">.</span><span class="n">loopCount</span> <span class="p">=</span> <span class="n">loopCount</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">			<span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">public</span> <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">thread</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">			<span class="p">{</span>  
</span></span><span class="line"><span class="cl">				<span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">			<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">loopCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">			<span class="p">{</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;系统当前时间毫秒值：&#34;</span> <span class="p">+</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">				<span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">);</span><span class="c1">//让线程暂停  </span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="k">class</span> <span class="nc">Program</span>  
</span></span><span class="line"><span class="cl">	<span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">		<span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="n">MyThreadParameter</span> <span class="n">parameterThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MyThreadParameter</span><span class="p">(</span><span class="m">30</span><span class="p">,</span> <span class="m">5</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">			<span class="n">parameterThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">		<span class="p">}</span>  
</span></span><span class="line"><span class="cl">	<span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">结果</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">438</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">471</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">502</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">533</span>
</span></span><span class="line"><span class="cl"><span class="err">系统当前时间毫秒值：</span><span class="m">563</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="多线程同干一件事" class="heading-element"><span>多线程同干一件事</span>
  <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%90%8c%e5%b9%b2%e4%b8%80%e4%bb%b6%e4%ba%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>多线程同干一件事的时候对发生一些问题</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">ThreadLock</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Thread</span> <span class="n">threadOne</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Thread</span> <span class="n">threadTwo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">ticketList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">object</span> <span class="n">objLock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadOne</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadOne</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread_1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadTwo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadTwo</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread_2&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ThreadLock</span> <span class="n">th</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThreadLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">th</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ticketList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ticketList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">PadLeft</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">));</span><span class="c1">//实现3位的票号，如果不足3位数，则以0补足3位  </span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadOne</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">threadTwo</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">ticketList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="c1">//①  </span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">string</span> <span class="n">ticketNo</span> <span class="p">=</span> <span class="n">ticketList</span><span class="p">[</span><span class="m">0</span><span class="p">];</span><span class="c1">//②  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0}:售出一张票，票号：{1}&#34;</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">ticketNo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ticketList</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span><span class="c1">//③  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">001</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_2</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">001</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">003</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_2</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">004</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">005</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_2</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">006</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">007</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_2</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">008</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">008</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_2</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">010</span>
</span></span><span class="line"><span class="cl"><span class="n">Thread_1</span><span class="p">:</span><span class="err">售出一张票，票号：</span><span class="m">010</span>
</span></span><span class="line"><span class="cl"><span class="err">未经处理的异常</span><span class="p">:</span>  <span class="n">System</span><span class="p">.</span><span class="n">ArgumentOutOfRangeException</span><span class="p">:</span> <span class="err">索引超出范围。必须为非负值并小于集合大小。</span>
</span></span><span class="line"><span class="cl"><span class="err">参数名</span><span class="p">:</span> <span class="n">index</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">ThrowHelper</span><span class="p">.</span><span class="n">ThrowArgumentOutOfRangeException</span><span class="p">(</span><span class="n">ExceptionArgument</span> <span class="n">argument</span><span class="p">,</span> <span class="n">ExceptionResource</span> <span class="n">resource</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">Generic</span><span class="p">.</span><span class="n">List</span><span class="err">`</span><span class="m">1.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">Int32</span> <span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">StartThread</span><span class="p">.</span><span class="n">ThreadLock</span><span class="p">.</span><span class="n">Run</span><span class="p">()</span> <span class="err">位置</span> <span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">Users</span><span class="err">\</span><span class="n">DuJinfeng</span><span class="err">\</span><span class="n">Desktop</span><span class="err">\</span><span class="n">C</span><span class="err">#源码\</span><span class="n">test</span><span class="err">\</span><span class="n">test</span><span class="err">\练习\</span><span class="n">test</span><span class="err">\</span><span class="n">Program</span><span class="p">.</span><span class="n">cs</span><span class="p">:</span><span class="err">行号</span> <span class="m">79</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ThreadHelper</span><span class="p">.</span><span class="n">ThreadStart_Context</span><span class="p">(</span><span class="n">Object</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ExecutionContext</span><span class="p">.</span><span class="n">RunInternal</span><span class="p">(</span><span class="n">ExecutionContext</span> <span class="n">executionContext</span><span class="p">,</span> <span class="n">ContextCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="n">Object</span> <span class="n">state</span><span class="p">,</span> <span class="n">Boolean</span> <span class="n">preserveSyncCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ExecutionContext</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ExecutionContext</span> <span class="n">executionContext</span><span class="p">,</span> <span class="n">ContextCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="n">Object</span> <span class="n">state</span><span class="p">,</span> <span class="n">Boolean</span> <span class="n">preserveSyncCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ExecutionContext</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ExecutionContext</span> <span class="n">executionContext</span><span class="p">,</span> <span class="n">ContextCallback</span> <span class="n">callback</span><span class="p">,</span> <span class="n">Object</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="err">在</span> <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">ThreadHelper</span><span class="p">.</span><span class="n">ThreadStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>该程序在③处会出现问题，如果第一个线程在③处的时间片段正好用完第二个线程调用就会出现一张票被卖两次的问题</li>
<li>同步问题的解决方法：
<ul>
<li>lock、</li>
<li>Mutex、</li>
<li>Monitor、</li>
<li>Semaphore、</li>
<li>Interlocked</li>
<li>ReaderWriterLock等</li>
<li>同步策略可以有同步上下文、同步代码区、手动同步</li>
</ul>
</li>
</ul>
<h3 id="上下文同步策略" class="heading-element"><span>上下文同步策略</span>
  <a href="#%e4%b8%8a%e4%b8%8b%e6%96%87%e5%90%8c%e6%ad%a5%e7%ad%96%e7%95%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>上下文同步：</li>
<li>同步上下文的策略主要是依靠SynchronizationAttribute类来实现</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//需要添加对System.EnterpriseServices.dll这个类库的引用采用使用这个dll  </span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.EnterpriseServices</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="na">    [Synchronization(SynchronizationOption.Required)]</span><span class="c1">//确保创建的对象已经同步  </span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">SynchronizationAttributeClass</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> </span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>所有在同一个上下文域的对象共享同一个锁。这样创建的对象实例属性、方法和字段就具有线程安全性，需要注意的是类的静态字段、属性和方法是不具有线程安全性的。</li>
</ul>
<h3 id="同步代码区" class="heading-element"><span>同步代码区</span>
  <a href="#%e5%90%8c%e6%ad%a5%e4%bb%a3%e7%a0%81%e5%8c%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>同步代码区是另外一种策略，它是针对特定部分代码进行同步的一种方法</p>
<ul>
<li>lock同步</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ticketList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="c1">//①  </span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">lock</span> <span class="p">(</span><span class="n">objLock</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ticketList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="c1">//必须要再一次判断在1之后可能进入其他线程</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="kt">string</span> <span class="n">ticketNo</span> <span class="p">=</span> <span class="n">ticketList</span><span class="p">[</span><span class="m">0</span><span class="p">];</span><span class="c1">//②  </span>
</span></span><span class="line"><span class="cl">                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0}:售出一张票，票号：{1}&#34;</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">ticketNo</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">ticketList</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span><span class="c1">//③  </span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Monitor类同步</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ticketList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span><span class="c1">//①  </span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">objLock</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ticketList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="kt">string</span> <span class="n">ticketNo</span> <span class="p">=</span> <span class="n">ticketList</span><span class="p">[</span><span class="m">0</span><span class="p">];</span><span class="c1">//②  </span>
</span></span><span class="line"><span class="cl">                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0}:售出一张票，票号：{1}&#34;</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">ticketNo</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">ticketList</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span><span class="c1">//③  </span>
</span></span><span class="line"><span class="cl">                    <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">objLock</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>使用lock关键字的代码实际上是用Monitor来实现的。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">lock</span> <span class="p">(</span><span class="n">objLock</span><span class="p">){</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//同步代码  </span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//等价于</span>
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">objLock</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="c1">//同步代码  </span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="k">finally</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl"><span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">objLock</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Monitor类除了Enter()和Exit()方法之外，还有Wait()和Pulse()方法。</li>
<li>Wait()方法是<strong>临时释放当前活得的锁</strong>，并使当前对象处于阻塞状态</li>
<li>Pulse()方法是通知处于等待状态的对象可以准备就绪了，它一会就会释放锁</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">ThreadDemo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Thread</span> <span class="n">threadOne</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Thread</span> <span class="n">threadTwo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span> <span class="n">stringList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">event</span> <span class="n">EventHandler</span> <span class="n">OnNumberClear</span><span class="p">;</span><span class="c1">//数据删除完成引发的事件</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadDemo</span> <span class="n">demo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThreadDemo</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">demo</span><span class="p">.</span><span class="n">Action</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ThreadDemo</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Random</span> <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">stringList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">stringList</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">Next</span><span class="p">().</span><span class="n">ToString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadOne</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span><span class="c1">//两个线程共同做一件事情</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadTwo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span><span class="c1">//两个线程共同做一件事情</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">threadOne</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;线程1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadTwo</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;线程2&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">number</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;主线程1：{i.ToString()}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnNumberClear</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">EventHandler</span><span class="p">(</span><span class="n">ThreadDemo_OnNumberClear</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 开始工作</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Action</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadOne</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadTwo</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 共同做的工作</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">stringValue</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="c1">//锁定，保持同步</span>
</span></span><span class="line"><span class="cl">            <span class="n">stringValue</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">stringList</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&#34;删除了&#34;</span> <span class="p">+</span> <span class="n">stringValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">stringList</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span><span class="c1">//删除ArrayList中的元素</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">stringList</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">OnNumberClear</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">new</span> <span class="n">EventArgs</span><span class="p">());</span><span class="c1">//引发完成事件</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="c1">//取消锁定</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//执行完成之后，停止所有线程</span>
</span></span><span class="line"><span class="cl">    <span class="k">void</span> <span class="n">ThreadDemo_OnNumberClear</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;执行完了，停止了所有线程的执行。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadTwo</span><span class="p">.</span><span class="n">Abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">threadOne</span><span class="p">.</span><span class="n">Abort</span><span class="p">();</span><span class="c1">//终止线程调用</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="err">主线程</span><span class="m">1</span><span class="err">：</span><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">1</span><span class="err">删除了</span><span class="m">2080427802</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">2</span><span class="err">删除了</span><span class="m">341851734</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">1</span><span class="err">删除了</span><span class="m">1431988776</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">2</span><span class="err">删除了</span><span class="m">1938005744</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">1</span><span class="err">删除了</span><span class="m">761513014</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">2</span><span class="err">删除了</span><span class="m">2037243568</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">1</span><span class="err">删除了</span><span class="m">1528357293</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">2</span><span class="err">删除了</span><span class="m">1311292502</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">1</span><span class="err">删除了</span><span class="m">749943798</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span><span class="m">2</span><span class="err">删除了</span><span class="m">319576108</span>
</span></span><span class="line"><span class="cl"><span class="err">执行完了，停止了所有线程的执行。</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">ThreadWaitAndPluse</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">object</span> <span class="n">lockObject</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Random</span> <span class="n">random</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadWaitAndPluse</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">lockObject</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//显示生成数据的线程要执行的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">ThreadMethodOne</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//获取对象锁  </span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;当前进入的线程：&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">Monitor</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//释放对象锁，并阻止当前线程  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;WaitAndPluse1:工作&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;WaitAndPluse1:得到了数据，number=&#34;</span> <span class="p">+</span> <span class="n">number</span> <span class="p">+</span> <span class="s">&#34;,Thread ID=&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">//通知其它等待锁的对象状态已经发生改变,当这个对象释放锁之后等待锁的对象将会活得锁  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Monitor</span><span class="p">.</span><span class="n">Pulse</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;退出当前线程：&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//释放对象锁  </span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//生成随机数据线程要执行的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">ThreadMethodTwo</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//获取对象锁  </span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;当前进入的线程：&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">//通知其它等待锁的对象状态已经发生改变,当这个对象释放锁之后等待锁的对象将会活得锁  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Monitor</span><span class="p">.</span><span class="n">Pulse</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;WaitAndPluse2:工作&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="n">number</span> <span class="p">=</span><span class="n">random</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Millisecond</span><span class="p">);</span><span class="c1">//生成随机数  </span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;WaitAndPluse2:生成了数据，number=&#34;</span> <span class="p">+</span> <span class="n">number</span> <span class="p">+</span> <span class="s">&#34;,Thread ID=&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">                <span class="n">Monitor</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//释放对象锁，并阻止当前线程  </span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;退出当前线程：&#34;</span> <span class="p">+</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">GetHashCode</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">lockObject</span><span class="p">);</span><span class="c1">//释放对象锁  </span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadWaitAndPluse</span> <span class="n">demo</span><span class="p">=</span><span class="k">new</span> <span class="n">ThreadWaitAndPluse</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">demo</span><span class="p">.</span><span class="n">ThreadMethodOne</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">t1</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">demo</span><span class="p">.</span><span class="n">ThreadMethodTwo</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">t2</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="err">当前进入的线程：</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="err">当前进入的线程：</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">生成了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">128</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">得到了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">128</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">生成了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">34</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">得到了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">34</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">生成了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">615</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">得到了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">615</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">生成了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">759</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">得到了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">759</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse2</span><span class="p">:</span><span class="err">生成了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">894</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">工作</span>
</span></span><span class="line"><span class="cl"><span class="n">WaitAndPluse1</span><span class="p">:</span><span class="err">得到了数据，</span><span class="n">number</span><span class="p">=</span><span class="m">894</span><span class="p">,</span><span class="n">Thread</span> <span class="n">ID</span><span class="p">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="err">退出当前线程：</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="err">退出当前线程：</span><span class="m">4</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个一般情况下都是正常的，但是不能保证线程1先执行,为了避免这种情况可以让线程2延迟一个合适的时间</li>
</ul>
<h3 id="手动同步" class="heading-element"><span>手动同步</span>
  <a href="#%e6%89%8b%e5%8a%a8%e5%90%8c%e6%ad%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>
<p>ReaderWriterLock：ReaderWriterLock支持<strong>单个写线程和多个读线程的锁</strong>，使用ReaderWriterLock来进行读写同步比使用监视的方式（如Monitor）效率要高</p>
</li>
<li>
<p>.NET Framework 具有两个读取器 / 编写器锁， ReaderWriterLockSlim 和 ReaderWriterLock。 ReaderWriterLockSlim 建议将所有新的开发的。 ReaderWriterLockSlim 类似于 ReaderWriterLock, ，只是简化了递归、 升级和降级锁定状态的规则。 ReaderWriterLockSlim 可避免潜在的死锁的很多情况。 此外，性能的 ReaderWriterLockSlim 明显优于 ReaderWriterLock。</p>
</li>
<li>
<p>ReaderWriterLock 用于同步对资源的访问。 在任何给定时间，它允许多个线程的并发读访问权限，或者一个单独的线程的写访问权限。 在某个资源，很少更改的情况下 ReaderWriterLock 提供了更好的吞吐量比简单的一次锁，如 Monitor。</p>
</li>
<li>
<p>ReaderWriterLock 其中大多数的访问权限是读取，而写入是很少和持续时间较短的效果最佳。 多个读取器交替使用单个编写器，以便读取器和编写器都不被阻止较长时间</p>
</li>
</ul>
<p>下面的示例演示如何使用 ReaderWriterLock 若要保护的共享的资源，一个整数值，名为 resource, ，即并发读取和写入以独占方式由多个线程。 请注意， ReaderWriterLock 以便对所有线程可见的类级别声明。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Example</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">ReaderWriterLock</span> <span class="n">rwl</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReaderWriterLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 定义受ReaderWriterLock保护的共享资源。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">resource</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 线程数量</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="kt">int</span> <span class="n">numThreads</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 线程启动开关</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">bool</span> <span class="n">running</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// 随机</span>
</span></span><span class="line"><span class="cl">    <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">Random</span> <span class="n">rnd</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 读取超时时间</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">readerTimeouts</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//写入超时时间</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">writerTimeouts</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//读取次数</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">reads</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//写入次数</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">writes</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 启动一系列线程以随机读取和写入共享资源。</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">[]</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">[</span><span class="n">numThreads</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Name</span> <span class="p">=</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">ToChar</span><span class="p">(</span><span class="n">i</span> <span class="p">+</span> <span class="m">65</span><span class="p">),</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;线程：{t[i].Name }启动&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="p">&gt;</span> <span class="m">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">300</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 告诉线程关闭并等待它们全部完成。</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numThreads</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Join</span><span class="p">();</span><span class="c1">//阻止调用线程，直到某个线程终止时为止。</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;线程：{t[i].Name }阻止&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 显示统计信息</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;\n{reads} 次读, {writes} 次写, 读取请求超时时间{readerTimeouts} , 写请求超时时间{writerTimeouts} .&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;退出 &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">ThreadProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 随机选择线程从共享资源中读取和写入的方式</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">action</span> <span class="p">=</span> <span class="n">rnd</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span><span class="c1">//返回一个0-1之间的随机数</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="p">&lt;</span> <span class="p">.</span><span class="m">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReadFromResource</span><span class="p">(</span><span class="m">10</span><span class="p">);</span><span class="c1">//80%读</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="p">&lt;</span> <span class="p">.</span><span class="m">81</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReleaseRestore</span><span class="p">(</span><span class="m">50</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="p">&lt;</span> <span class="p">.</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">UpgradeDowngrade</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="n">WriteToResource</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 请求并释放读卡器锁，并处理超时。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">ReadFromResource</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rwl</span><span class="p">.</span><span class="n">AcquireReaderLock</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span><span class="c1">//获取读线程锁。//使用一个int超时值获取读线程</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 此线程可以安全地从共享资源中读取。</span>
</span></span><span class="line"><span class="cl">                <span class="n">Display</span><span class="p">(</span><span class="s">&#34;读取资源值:&#34;</span> <span class="p">+</span> <span class="n">resource</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">reads</span><span class="p">);</span><span class="c1">//对资源操作</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 确保已释放锁定。</span>
</span></span><span class="line"><span class="cl">                <span class="n">rwl</span><span class="p">.</span><span class="n">ReleaseReaderLock</span><span class="p">();</span><span class="c1">//减少锁计数。</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">ApplicationException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//读卡器锁定请求超时。</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">readerTimeouts</span><span class="p">);</span><span class="c1">//时间增加</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 请求并释放写入程序锁定，并处理超时。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">WriteToResource</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rwl</span><span class="p">.</span><span class="n">AcquireWriterLock</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span><span class="c1">//获取写线程锁。//使用一个int超时值获取写线程</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 此线程可以安全地从共享资源进行访问。</span>
</span></span><span class="line"><span class="cl">                <span class="n">resource</span> <span class="p">=</span> <span class="n">rnd</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Display</span><span class="p">(</span><span class="s">&#34;写资源值: &#34;</span> <span class="p">+</span> <span class="n">resource</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">writes</span><span class="p">);</span><span class="c1">//写入次数</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 确保已释放锁定。</span>
</span></span><span class="line"><span class="cl">                <span class="n">rwl</span><span class="p">.</span><span class="n">ReleaseWriterLock</span><span class="p">();</span><span class="c1">//减少写线程上锁的计数</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">ApplicationException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// The writer lock request timed out.</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">writerTimeouts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 请求读取器锁定，将读取器锁定升级到写入器锁定，并再次将其降级为读取器锁定。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">UpgradeDowngrade</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rwl</span><span class="p">.</span><span class="n">AcquireReaderLock</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span><span class="c1">//通过设置的读时间int值获取读线程锁</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 这个线程从共享资源中读取是安全的。</span>
</span></span><span class="line"><span class="cl">                <span class="n">Display</span><span class="p">(</span><span class="s">&#34;读资源值: &#34;</span> <span class="p">+</span> <span class="n">resource</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">reads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 要写入资源，要么释放读取器锁定并请求写入程序锁定，要么升级读取器锁定。</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//升级读取器锁将线程置于写入队列中，位于可能正在等待写入器锁定的任何其他线程之后。</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">LockCookie</span> <span class="n">lc</span> <span class="p">=</span> <span class="n">rwl</span><span class="p">.</span><span class="n">UpgradeToWriterLock</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span><span class="c1">//将一个设置超时int值的读线程锁升级为写线程锁</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 此线程可以安全地从共享资源读取或写入。</span>
</span></span><span class="line"><span class="cl">                        <span class="n">resource</span> <span class="p">=</span> <span class="n">rnd</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Display</span><span class="p">(</span><span class="s">&#34;从读锁变成写锁写资源值: &#34;</span> <span class="p">+</span> <span class="n">resource</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">writes</span><span class="p">);</span><span class="c1">//写值</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="k">finally</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// 确保已释放锁定。</span>
</span></span><span class="line"><span class="cl">                        <span class="n">rwl</span><span class="p">.</span><span class="n">DowngradeFromWriterLock</span><span class="p">(</span><span class="k">ref</span> <span class="n">lc</span><span class="p">);</span><span class="c1">//将线程的锁状态还原为调用 UpgradeToWriterLock 前的状态。</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">catch</span> <span class="p">(</span><span class="n">ApplicationException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// 更新写线程时间</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">writerTimeouts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// 如果锁被降级，从资源中读取仍然是安全的。</span>
</span></span><span class="line"><span class="cl">                <span class="n">Display</span><span class="p">(</span><span class="s">&#34;从读锁变成写锁再变读锁读资源值: &#34;</span> <span class="p">+</span> <span class="n">resource</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">reads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 确保已释放锁定。</span>
</span></span><span class="line"><span class="cl">                <span class="n">rwl</span><span class="p">.</span><span class="n">ReleaseReaderLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">ApplicationException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 读卡器锁定请求超时。</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">readerTimeouts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//释放所有锁，然后恢复锁定状态。</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//使用序列号来确定另一个线程是否已获得写入器锁定，因为此线程上次访问该资源。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">ReleaseRestore</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeOut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">lastWriter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rwl</span><span class="p">.</span><span class="n">AcquireReaderLock</span><span class="p">(</span><span class="n">timeOut</span><span class="p">);</span><span class="c1">//使用一个 Int32 超时值获取读线程锁。</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 此线程可以安全地从共享资源中读取，因此读取并缓存资源值。</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">resourceValue</span> <span class="p">=</span> <span class="n">resource</span><span class="p">;</span>     <span class="c1">// 缓存资源值。</span>
</span></span><span class="line"><span class="cl">                <span class="n">Display</span><span class="p">(</span><span class="s">&#34;读取资源值: &#34;</span> <span class="p">+</span> <span class="n">resourceValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">reads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 保存当前的编写器序列号。</span>
</span></span><span class="line"><span class="cl">                <span class="n">lastWriter</span> <span class="p">=</span> <span class="n">rwl</span><span class="p">.</span><span class="n">WriterSeqNum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 释放锁并保存cookie，以便稍后恢复锁定。</span>
</span></span><span class="line"><span class="cl">                <span class="n">LockCookie</span> <span class="n">lc</span> <span class="p">=</span> <span class="n">rwl</span><span class="p">.</span><span class="n">ReleaseLock</span><span class="p">();</span><span class="c1">//释放锁，不管线程获取锁的次数如何。</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 等待一个随机间隔，然后恢复以前的锁定状态。</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">rnd</span><span class="p">.</span><span class="n">Next</span><span class="p">(</span><span class="m">250</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="n">rwl</span><span class="p">.</span><span class="n">RestoreLock</span><span class="p">(</span><span class="k">ref</span> <span class="n">lc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 检查其他线程是否在间隔中获得了写入器锁定。 如果不是，则资源的缓存值仍然有效。</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">rwl</span><span class="p">.</span><span class="n">AnyWritersSince</span><span class="p">(</span><span class="n">lastWriter</span><span class="p">))</span><span class="c1">//指示获取序列号之后是否已将写线程锁授予某个线程。</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">resourceValue</span> <span class="p">=</span> <span class="n">resource</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">reads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Display</span><span class="p">(</span><span class="s">&#34;读锁毁灭再恢复，资源值再次读:&#34;</span> <span class="p">+</span> <span class="n">resourceValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Display</span><span class="p">(</span><span class="s">&#34;读锁没有恢复：资源值没有改变:&#34;</span> <span class="p">+</span> <span class="n">resourceValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">finally</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 确保锁释放</span>
</span></span><span class="line"><span class="cl">                <span class="n">rwl</span><span class="p">.</span><span class="n">ReleaseReaderLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">ApplicationException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 读线程锁超时</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">readerTimeouts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Helper方法简要显示最近的线程操作。</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Display</span><span class="p">(</span><span class="kt">string</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;线程 {Thread.CurrentThread.Name}: {msg}.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">A启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">A</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">B启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">B</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">B</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">C启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">D启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">B</span><span class="p">:</span> <span class="err">写资源值</span><span class="p">:</span> <span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">B</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">12.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">写资源值</span><span class="p">:</span> <span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读资源值</span><span class="p">:</span> <span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">8.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">从读锁变成写锁写资源值</span><span class="p">:</span> <span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">从读锁变成写锁再变读锁读资源值</span><span class="p">:</span> <span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读资源值</span><span class="p">:</span> <span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">33.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">从读锁变成写锁写资源值</span><span class="p">:</span> <span class="m">84.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">E启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">从读锁变成写锁再变读锁读资源值</span><span class="p">:</span> <span class="m">84.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">84.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">84.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">F</span><span class="p">:</span> <span class="err">写资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">F</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">F启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">G启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">H启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">H</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">H</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">I启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">I</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">J启动</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">G</span><span class="p">:</span> <span class="err">读资源值</span><span class="p">:</span> <span class="m">0.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">H</span><span class="p">:</span> <span class="err">写资源值</span><span class="p">:</span> <span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">I</span><span class="p">:</span> <span class="err">读取资源值</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">J</span><span class="p">:</span> <span class="err">写资源值</span><span class="p">:</span> <span class="m">44.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">G</span><span class="p">:</span> <span class="err">从读锁变成写锁写资源值</span><span class="p">:</span> <span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">G</span><span class="p">:</span> <span class="err">从读锁变成写锁再变读锁读资源值</span><span class="p">:</span> <span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">C</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">F</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">B</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">A</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">A阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">B阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">C阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">E</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程</span> <span class="n">D</span><span class="p">:</span> <span class="err">读锁毁灭再恢复，资源值再次读</span><span class="p">:</span><span class="m">18.</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">D阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">E阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">F阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">G阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">H阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">I阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">线程：</span><span class="n">J阻止</span>
</span></span><span class="line"><span class="cl"><span class="m">50</span> <span class="err">次读</span><span class="p">,</span> <span class="m">8</span> <span class="err">次写</span><span class="p">,</span> <span class="err">读取请求超时时间</span><span class="m">0</span> <span class="p">,</span> <span class="err">写请求超时时间</span><span class="m">0</span> <span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">退出</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="autoresetevent-类" class="heading-element"><span>AutoResetEvent 类</span>
  <a href="#autoresetevent-%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>通知正在等待的线程已发生事件。MSCN介绍中，<strong>终止状态就是有信号</strong></p>
<ul>
<li>AutoResetEvent（bool isover）：构造函数指示是否指示是否将初始状态设置为终止的</li>
<li>Reset:将事件状态设置为非终止状态，导致线程阻止。</li>
<li>Set:将事件状态设置为终止状态，允许一个或多个等待线程继续。<strong>将事件状态设置为有信号</strong></li>
<li>WaitOne():阻止当前线程，直到当前 WaitHandle 收到信号。<strong>会自动改变信号，讲有信号自动变成无信号，需要自己调用set</strong></li>
<li>WaitOne(Int32):阻止当前线程，直到当前 WaitHandle 收到信号，同时使用 32 位带符号整数指定时间间隔</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Example</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//mscn中终止状态就是有信号</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//全局</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AutoResetEvent</span> <span class="n">event_1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="c1">//初始化为终止状态，有信号</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">AutoResetEvent</span> <span class="n">event_2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="c1">//初始状态为非终止状态，没有信号</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;按Enter键创建三个线程并启动它们。\r\n&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;线程在创建的AutoResetEvent1上等待\r\n&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;在信号状态，所以第一个线程被释放。\r\n&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;这使AutoResetEvent1进入无信号状态.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">4</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span>  <span class="n">i</span><span class="p">+</span> <span class="s">&#34;号线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0}号线程开始&#34;</span><span class="p">,</span><span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">250</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;按Enter键以释放另一个线程。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">event_1</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">250</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\r\n所有线程现在都在等待AutoResetEvent＃2。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;按Enter键以释放线程。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">event_2</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">250</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">ThreadProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} 等待AutoResetEvent # 1。&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_1</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} 从AutoResetEvent # 1中释放。&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} 等待AutoResetEvent # 2。&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_2</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} 从AutoResetEvent # 2中释放。&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} 结束。&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键创建三个线程并启动它们</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="err">线程在创建的</span><span class="n">AutoResetEvent1上等待</span>
</span></span><span class="line"><span class="cl"><span class="err">在信号状态，所以第一个线程被释放。</span>
</span></span><span class="line"><span class="cl"><span class="err">这使</span><span class="n">AutoResetEvent1进入无信号状态</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键以释放另一个线程</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键以释放另一个线程</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">1</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">等待</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">所有线程现在都在等待</span><span class="n">AutoResetEvent</span><span class="err">＃</span><span class="m">2</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键以释放线程</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">结束。</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键以释放线程</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">结束。</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键以释放线程</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">从</span><span class="n">AutoResetEvent</span> <span class="err">#</span> <span class="m">2</span><span class="err">中释放。</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">结束。</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="manualresetevent-类" class="heading-element"><span>ManualResetEvent 类</span>
  <a href="#manualresetevent-%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>通知一个或多个正在等待的线程已发生事件。</p>
<ul>
<li>ManualResetEvent：用一个指示是否将初始状态设置为终止的布尔值初始化，初始状态是否有信号</li>
<li>set:将事件状态设置为终止状态，允许一个或多个等待线程继续。,<strong>设置有信号,设为有信号后就一直有信号，即使waitone后也信号，直到reset将其设为无信号</strong></li>
<li>WaitOne()：阻止当前线程，直到当前 WaitHandle 收到信号。</li>
<li>WaitOne(Int32)：阻止当前线程，直到当前 WaitHandle 收到信号，同时使用 32 位带符号整数指定时间间隔（以毫秒为单位）。</li>
<li>Reset：将事件状态设置为非终止状态，导致线程阻止。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Example</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ManualResetEvent</span> <span class="n">mre</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManualResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="c1">//初始状态没有信号</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n启动3个在ManualResetEvent上阻塞的命名线程：\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">i</span><span class="p">+</span><span class="s">&#34;号线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0}开始&#34;</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n当所有三个线程都已启动时，按Enter键调用Set（）&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n释放所有线程。\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n发出ManualResetEvent信号时，调用WaitOne（）的线程&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n不要阻止。 按Enter键显示此信息。\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="m">4</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="s">&#34;号线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n按Enter键调用Reset（），以便线程再次阻止&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n当他们调用WaitOne（）时.\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Start a thread that waits on the ManualResetEvent.</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t5</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t5</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;Thread_5&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t5</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\nPress Enter to call Set() and conclude the demo.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">ThreadProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&#34; 启动并调用mre.WaitOne（）&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&#34; ends.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">结果：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">启动</span><span class="m">3</span><span class="err">个在</span><span class="n">ManualResetEvent上阻塞的命名线程</span><span class="err">：</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">0</span><span class="err">号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span><span class="err">号线程</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程开始</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">当所有三个线程都已启动时，按</span><span class="n">Enter键调用Set</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="err">释放所有线程。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">号线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span><span class="err">号线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">号线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">发出</span><span class="n">ManualResetEvent信号时</span><span class="err">，调用</span><span class="n">WaitOne</span><span class="err">（）的线程</span>
</span></span><span class="line"><span class="cl"><span class="err">不要阻止。</span> <span class="err">按</span><span class="n">Enter键显示此信息</span><span class="err">。</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">号线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span><span class="err">号线程</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span><span class="err">号线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter键调用Reset</span><span class="err">（），以便线程再次阻止</span>
</span></span><span class="line"><span class="cl"><span class="err">当他们调用</span><span class="n">WaitOne</span><span class="err">（）时</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Thread_5</span> <span class="err">启动并调用</span><span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Press</span> <span class="n">Enter</span> <span class="n">to</span> <span class="n">call</span> <span class="n">Set</span><span class="p">()</span> <span class="n">and</span> <span class="n">conclude</span> <span class="n">the</span> <span class="n">demo</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Thread_5</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="interlocked-类" class="heading-element"><span>Interlocked 类</span>
  <a href="#interlocked-%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>为多个线程共享的变量提供原子操作。</p>
<ul>
<li>Increment(Int32)：以原子操作的形式递增指定变量的值并存储结果。</li>
<li>Add(Int32, Int32)：对两个 32 位整数进行求和并用和替换第一个整数，上述操作作为一个原子操作完成。</li>
<li>CompareExchange(Double, Double, Double)：比较两个双精度浮点数是否相等，如果相等，则替换第一个值。</li>
</ul>
<h3 id="waithandle" class="heading-element"><span>waithandle</span>
  <a href="#waithandle" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>WaitHandle类是一个抽象类，有多个类直接或者间接继承自WaitHandle类</li>
<li>在WaitHandle类中SignalAndWait、WaitAll、WaitAny及WaitOne这几个方法都有重载形式，其中除WaitOne之外都是静态的。</li>
<li>WaitHandle方法常用作同步对象的基类。WaitHandle对象通知其他的线程它需要对资源排他性的访问，其他的线程必须等待，直到WaitHandle不再使用资源和等待句柄没有被使用。</li>
<li>WaitHandle方法有多个Wait的方法，这些方法的区别如下：
<ul>
<li>WaitAll：等待指定数组中的所有元素收到信号。</li>
<li>WaitAny：等待指定数组中的任一元素收到信号。</li>
<li>WaitOne：当在派生类中重写时，阻塞当前线程，直到当前的 WaitHandle 收到信号。</li>
</ul>
</li>
</ul>
<p>MSCN上面的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">AutoResetEvent_Examples</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MyMainClass</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Initially not signaled.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">const</span> <span class="kt">int</span> <span class="n">numIterations</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="n">AutoResetEvent</span> <span class="n">myResetEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Create and start the reader thread.</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">myReaderThread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">MyReadThreadProc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">myReaderThread</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;ReaderThread&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">myReaderThread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="n">numIterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Writer thread writing value: {0}&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">number</span> <span class="p">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Signal that a value has been written.</span>
</span></span><span class="line"><span class="cl">            <span class="n">myResetEvent</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//Give the Reader thread an opportunity to act.</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Terminate the reader thread.</span>
</span></span><span class="line"><span class="cl">        <span class="n">myReaderThread</span><span class="p">.</span><span class="n">Abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">MyReadThreadProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//The value will not be read until the writer has written</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// at least once since the last read.</span>
</span></span><span class="line"><span class="cl">            <span class="n">myResetEvent</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span><span class="c1">//等待set</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;{0} reading value: {1}&#34;</span><span class="p">,</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">结果</span>
</span></span><span class="line"><span class="cl"><span class="n">Writer</span> <span class="n">thread</span> <span class="n">writing</span> <span class="k">value</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">ReaderThread</span> <span class="n">reading</span> <span class="k">value</span><span class="p">:</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Writer</span> <span class="n">thread</span> <span class="n">writing</span> <span class="k">value</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">ReaderThread</span> <span class="n">reading</span> <span class="k">value</span><span class="p">:</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Writer</span> <span class="n">thread</span> <span class="n">writing</span> <span class="k">value</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">ReaderThread</span> <span class="n">reading</span> <span class="k">value</span><span class="p">:</span> <span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Writer</span> <span class="n">thread</span> <span class="n">writing</span> <span class="k">value</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">ReaderThread</span> <span class="n">reading</span> <span class="k">value</span><span class="p">:</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Writer</span> <span class="n">thread</span> <span class="n">writing</span> <span class="k">value</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">ReaderThread</span> <span class="n">reading</span> <span class="k">value</span><span class="p">:</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="err">请按任意键继续</span><span class="p">.</span> <span class="p">.</span> <span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">Example</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// mre is used to block and release threads manually. It is</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// created in the unsignaled state.</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ManualResetEvent</span> <span class="n">mre</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManualResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="c1">//设为非终止状态，线程会被阻塞</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n启动在MalualReSeTebug上阻止的3个命名线程:\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span>  <span class="n">i</span><span class="p">+</span><span class="s">&#34;线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n当所有三个线程都已启动时，按Enter调用SET（）&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n释放所有线程。\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span><span class="c1">//事件状态被设置为有信号，允许线程执行，3个线程执行，同时ManualResetEvent 被设置为终止状态，线程不会阻塞</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n当一个MavaReSeTeEvices被发出信号时，调用WAOTIONE（）的线程&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n不要阻塞。按Enter显示这一点。\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;=</span> <span class="m">4</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="n">i</span> <span class="p">+</span> <span class="s">&#34;线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n按Enter调用REST（），使线程再次阻塞&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">                          <span class="s">&#34;\n当他们调用WAOTIFEL（）时。\n&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span><span class="c1">//将ManualResetEvent 重新设为非终止状态</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Start a thread that waits on the ManualResetEvent.</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">t5</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadProc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t5</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;5线程&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">t5</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">500</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;\n按Enter调用SET（）并结束演示。&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If you run this example in Visual Studio, uncomment the following line:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Console.ReadLine();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">ThreadProc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&#34; starts and calls mre.WaitOne()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span><span class="c1">//当ManualResetEvent 设为非终止状态时，线程会被阻塞</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&#34; ends.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">启动在</span><span class="n">MalualReSeTebug上阻止的3个命名线程</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">当所有三个线程都已启动时，按</span><span class="n">Enter调用SET</span><span class="err">（）</span>
</span></span><span class="line"><span class="cl"><span class="err">释放所有线程。</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="err">线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">0</span><span class="err">线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="err">线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">当一个</span><span class="n">MavaReSeTeEvices被发出信号时</span><span class="err">，调用</span><span class="n">WAOTIONE</span><span class="err">（）的线程</span>
</span></span><span class="line"><span class="cl"><span class="err">不要阻塞。按</span><span class="n">Enter显示这一点</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="err">线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span><span class="err">线程</span> <span class="n">ends</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter调用REST</span><span class="err">（），使线程再次阻塞</span>
</span></span><span class="line"><span class="cl"><span class="err">当他们调用</span><span class="n">WAOTIFEL</span><span class="err">（）时。</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span><span class="err">线程</span> <span class="n">starts</span> <span class="n">and</span> <span class="n">calls</span> <span class="n">mre</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">按</span><span class="n">Enter调用SET</span><span class="err">（）并结束演示。</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>这个讲的是一个计算过程，最终的计算结果为第一项＋第二项＋第三项，在计算第一、二、三项时需要使用基数来进行计算。在代码中使用了线程池也就是ThreadPool来操作</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">StartThread</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">//下面的代码摘自MSDN，笔者做了中文代码注释  </span>
</span></span><span class="line"><span class="cl">    <span class="c1">//周公  </span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">class</span> <span class="nc">EventWaitHandleDemo</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">baseNumber</span><span class="p">,</span> <span class="n">firstTerm</span><span class="p">,</span> <span class="n">secondTerm</span><span class="p">,</span> <span class="n">thirdTerm</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">AutoResetEvent</span><span class="p">[]</span> <span class="n">autoEvents</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="n">ManualResetEvent</span> <span class="n">manualEvent</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//产生随机数的类.  </span>
</span></span><span class="line"><span class="cl">        <span class="n">Random</span> <span class="n">random</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">EventWaitHandleDemo</span> <span class="n">ewhd</span> <span class="p">=</span> <span class="k">new</span> <span class="n">EventWaitHandleDemo</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Result = {0}.&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">ewhd</span><span class="p">.</span><span class="n">Result</span><span class="p">(</span><span class="m">234</span><span class="p">).</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Result = {0}.&#34;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                <span class="n">ewhd</span><span class="p">.</span><span class="n">Result</span><span class="p">(</span><span class="m">55</span><span class="p">).</span><span class="n">ToString</span><span class="p">());</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//构造函数  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">EventWaitHandleDemo</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">autoEvents</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">[]</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>  
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">};</span>  
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManualResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//计算基数  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">CalculateBase</span><span class="p">(</span><span class="kt">object</span> <span class="n">stateInfo</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">baseNumber</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//指示基数已经算好.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="c1">//计算第一项  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">CalculateFirstTerm</span><span class="p">(</span><span class="kt">object</span> <span class="n">stateInfo</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//生成随机数  </span>
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">preCalc</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//等待基数以便计算.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//通过preCalc和baseNumber计算第一项.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">firstTerm</span> <span class="p">=</span> <span class="n">preCalc</span> <span class="p">*</span> <span class="n">baseNumber</span> <span class="p">*</span><span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//发出信号指示计算完成.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">autoEvents</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Set</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//计算第二项  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">CalculateSecondTerm</span><span class="p">(</span><span class="kt">object</span> <span class="n">stateInfo</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">preCalc</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">secondTerm</span> <span class="p">=</span> <span class="n">preCalc</span> <span class="p">*</span> <span class="n">baseNumber</span> <span class="p">*</span><span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">autoEvents</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Set</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//计算第三项  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">CalculateThirdTerm</span><span class="p">(</span><span class="kt">object</span> <span class="n">stateInfo</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">double</span> <span class="n">preCalc</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thirdTerm</span> <span class="p">=</span> <span class="n">preCalc</span> <span class="p">*</span> <span class="n">baseNumber</span> <span class="p">*</span><span class="n">random</span><span class="p">.</span><span class="n">NextDouble</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">autoEvents</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Set</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//计算结果  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kt">double</span> <span class="n">Result</span><span class="p">(</span><span class="kt">int</span> <span class="n">seed</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">random</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//同时计算  </span>
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">CalculateFirstTerm</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">CalculateSecondTerm</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">CalculateThirdTerm</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">CalculateBase</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//等待所有的信号.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">WaitHandle</span><span class="p">.</span><span class="n">WaitAll</span><span class="p">(</span><span class="n">autoEvents</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//重置信号，以便等待下一次计算.  </span>
</span></span><span class="line"><span class="cl">            <span class="n">manualEvent</span><span class="p">.</span><span class="n">Reset</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//返回计算结果  </span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">firstTerm</span> <span class="p">+</span> <span class="n">secondTerm</span> <span class="p">+</span> <span class="n">thirdTerm</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="err">程序的运行结果如下：</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="p">=</span> <span class="m">0.355650523270459</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Result</span> <span class="p">=</span> <span class="m">0.125205692112756</span><span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="线程池" class="heading-element"><span>线程池</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e6%b1%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>为了处理短时间内大量创建对象，简单处理下，又要销毁损耗性能的行为，线程过多后会增加操作系统资源的占用，多线程资源竞争变得复杂
线程池的优点：</p>
<ul>
<li>缩短程序的响应时间</li>
<li>不必维护管理生存周期短暂的问题</li>
<li>线程池会根据当前系统特点对池内的线程进行优化处理</li>
</ul>
<p>在.NET中有一个线程的类ThreadPool，它提供了线程池的管理</p>
<p>ThreadPool是一个静态类，它没有构造函数，对外提供的函数也全部是静态的。其中有一个QueueUserWorkItem方法，它有两种重载形式，如下：</p>
<ul>
<li><code>public static bool QueueUserWorkItem(WaitCallback callBack)</code>:将方法排入队列以便执行。此方法在有线程池线程变得可用时执行。</li>
<li><code>public static bool QueueUserWorkItem(WaitCallback callBack,Object state)</code>:将方法排入队列以便执行，并指定包含该方法所用数据的对象。此方法在有线程池线程变得可用时执行。</li>
</ul>
<p>QueueUserWorkItem方法中使用的的WaitCallback参数表示一个delegate，它的声明如下：</p>
<ul>
<li>public delegate void WaitCallback(Object state)</li>
<li>如果需要传递任务信息可以利用WaitCallback中的state参数，类似于ParameterizedThreadStart委托</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">ThreadPoolDemo1</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadPoolDemo1</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">Work</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">CountProcess</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">new</span> <span class="n">WaitCallback</span><span class="p">(</span><span class="n">GetEnvironmentVariables</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// 统计当前正在运行的系统进程信息  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;param name=&#34;state&#34;&gt;&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">CountProcess</span><span class="p">(</span><span class="kt">object</span> <span class="n">state</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Process</span><span class="p">[]</span> <span class="n">processes</span> <span class="p">=</span> <span class="n">Process</span><span class="p">.</span><span class="n">GetProcesses</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="n">Process</span> <span class="n">p</span> <span class="k">in</span> <span class="n">processes</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="k">try</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Id:{0},ProcessName:{1},StartTime:{2}&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">ProcessName</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">StartTime</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">catch</span> <span class="p">(</span><span class="n">Win32Exception</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;ProcessName:{0}&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">ProcessName</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">finally</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;获取进程信息完毕。&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// 获取当前机器系统变量设置  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;/summary&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="cs">/// &lt;param name=&#34;state&#34;&gt;&lt;/param&gt;  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="k">void</span> <span class="n">GetEnvironmentVariables</span><span class="p">(</span><span class="kt">object</span> <span class="n">state</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">IDictionary</span> <span class="n">list</span><span class="p">=</span><span class="n">System</span><span class="p">.</span><span class="n">Environment</span><span class="p">.</span><span class="n">GetEnvironmentVariables</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="n">DictionaryEntry</span> <span class="n">item</span> <span class="k">in</span> <span class="n">list</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;key={0},value={1}&#34;</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;获取系统变量信息完毕。&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">ThreadPoolDemo1</span> <span class="n">tpd1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ThreadPoolDemo1</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">tpd1</span><span class="p">.</span><span class="n">Work</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的代码中我们使用了线程池，并让它执行了两个任务，一个是列出系统当前所有环境变量的值，一个是列出系统当前运行的进程名和它们的启动时间。</p>
<p>当然，优点和缺点总是同时存在的，使用ThreadPool也有一些缺点，使用线程池有如下缺点：</p>
<ul>
<li>
<p>1、一旦加入到线程池中就没有办法让它停止，除非任务执行完毕自动停止；</p>
</li>
<li>
<p>2、一个进程共享一个线程池；</p>
</li>
<li>
<p>3、要执行的任务不能有返回值（当然，线程中要执行的方法也是不能有返回值，如果确实需要返回值必须采用其它技巧来解决）；</p>
</li>
<li>
<p>4、在线程池中所有任务的优先级都是一样的，无法设置任务的优先级；</p>
</li>
<li>
<p>5、不太适合需要长期执行的任务（比如在Windows服务中执行），也不适合大的任务；</p>
</li>
<li>
<p>6、不能为线程设置稳定的关联标识，比如为线程池中执行某个特定任务的线程指定名称或者其它属性。</p>
</li>
</ul>
<p>如果我们要面临的情况正好是线程池的缺点，那么我们只好继续使用线程而不是线程池。不过在某些情况下使用线程池确实可以带来很多方便的，比如在WEB服务器中，可以使用线程池来处理来自客户端的请求，可以以比较高的性能运行。</p>
<h2 id="ui界面卡顿的问题" class="heading-element"><span>UI界面卡顿的问题</span>
  <a href="#ui%e7%95%8c%e9%9d%a2%e5%8d%a1%e9%a1%bf%e7%9a%84%e9%97%ae%e9%a2%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在开发Windows应用程序时经常会使用到线程。对于耗时的操作如果不使用线程将会是UI界面长时间处于停滞状态，这种情况是用户非常不愿意看到的，在这种情况下我们希望使用线程来解决这个问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">ThreadForm</span> <span class="p">:</span> <span class="n">Form</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadForm</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnThread_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">PerformStep</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p>本意是点击“启动”按钮来启动模拟一个操作，在进度条中显示操作的总体进度。不过如果我们真的点击“启动”按钮会很失望，因为它会抛出一个<code>System.InvalidOperationException</code>异常，异常描述就是“线程间操作无效: <strong>从不是创建控件‘progressBar’的线程访问它</strong>。”</p>
<p>解决方案</p>
<ul>
<li>CheckForIllegalCrossThreadCalls属性</li>
</ul>
<p>因为在.NET中做了限制，不允许在调试环境下使用线程访问并非它自己创建的UI控件，这么做可能是怕在多线程环境下对界面控件进行操作会出现不可预知的情况，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">ThreadForm</span> <span class="p">:</span> <span class="n">Form</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadForm</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnThread_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//指示是否对错误线程的调用，即是否允许在创建UI的线程之外访问线程  </span>
</span></span><span class="line"><span class="cl">            <span class="n">CheckForIllegalCrossThreadCalls</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">PerformStep</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> </span></span></code></pre></td></tr></table>
</div>
</div><p>不过使用上面的代码我们可能还有些犯嘀咕，毕竟是不允许直接在线程中直接操作界面的，那么我们还可以用Invoke方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>   
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">ThreadForm</span> <span class="p">:</span> <span class="n">Form</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//定义delegate以便Invoke时使用  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadForm</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnThread_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//指示是否对错误线程的调用，即是否允许在创建UI的线程之外访问线程  </span>
</span></span><span class="line"><span class="cl">            <span class="c1">//CheckForIllegalCrossThreadCalls = false;  </span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用线程来直接设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">PerformStep</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnInvoke_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">RunWithInvoke</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用Invoke方法来设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">RunWithInvoke</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">value</span><span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">//如果是跨线程调用  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="n">SetProgressValue</span><span class="p">),</span> <span class="k">value</span><span class="p">++);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="p">++</span><span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//跟SetProgressBarValue委托相匹配的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">SetProgressValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p>还可以使用BackgroundWorker类来完成同样的功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">ThreadForm</span> <span class="p">:</span> <span class="n">Form</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//定义delegate以便Invoke时使用  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">BackgroundWorker</span> <span class="n">worker</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadForm</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnThread_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//指示是否对错误线程的调用，即是否允许在创建UI的线程之外访问线程  </span>
</span></span><span class="line"><span class="cl">            <span class="c1">//CheckForIllegalCrossThreadCalls = false;  </span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用线程来直接设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">PerformStep</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnInvoke_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">RunWithInvoke</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用Invoke方法来设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">RunWithInvoke</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">value</span><span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">//如果是跨线程调用  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="n">SetProgressValue</span><span class="p">),</span> <span class="k">value</span><span class="p">++);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="p">++</span><span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//跟SetProgressBarValue委托相匹配的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">SetProgressValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnBackgroundWorker_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BackgroundWorker</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">DoWork</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">DoWorkEventHandler</span><span class="p">(</span><span class="n">worker_DoWork</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//当工作进度发生变化时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">ProgressChanged</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">ProgressChangedEventHandler</span><span class="p">(</span><span class="n">worker_ProgressChanged</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//当事件处理完毕后执行的方法  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">RunWorkerCompleted</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">RunWorkerCompletedEventHandler</span><span class="p">(</span><span class="n">worker_RunWorkerCompleted</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">WorkerReportsProgress</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span><span class="c1">//支持报告进度更新  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">WorkerSupportsCancellation</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span><span class="c1">//不支持异步取消  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">RunWorkerAsync</span><span class="p">();</span><span class="c1">//启动执行  </span>
</span></span><span class="line"><span class="cl">            <span class="n">btnBackgroundWorker</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//当事件处理完毕后执行的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_RunWorkerCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RunWorkerCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">btnBackgroundWorker</span><span class="p">.</span><span class="n">Enabled</span><span class="p">=</span><span class="kc">true</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//当工作进度发生变化时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_ProgressChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ProgressChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//可以在这个方法中与界面进行通讯  </span>
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//开始启动工作时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_DoWork</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DoWorkEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">worker</span><span class="p">.</span><span class="n">ReportProgress</span><span class="p">(++</span><span class="k">value</span><span class="p">);</span><span class="c1">//汇报进度  </span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span>  </span></span></code></pre></td></tr></table>
</div>
</div><p>System.Windows.Forms.Timer类也能完场上面的功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">ThreadPoolDemo</span>  
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">ThreadForm</span> <span class="p">:</span> <span class="n">Form</span>  
</span></span><span class="line"><span class="cl">    <span class="p">{</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//定义delegate以便Invoke时使用  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">BackgroundWorker</span> <span class="n">worker</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">ThreadForm</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">InitializeComponent</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnThread_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//指示是否对错误线程的调用，即是否允许在创建UI的线程之外访问线程  </span>
</span></span><span class="line"><span class="cl">            <span class="c1">//CheckForIllegalCrossThreadCalls = false;  </span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">Run</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用线程来直接设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">Run</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">PerformStep</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnInvoke_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ThreadStart</span><span class="p">(</span><span class="n">RunWithInvoke</span><span class="p">));</span>  
</span></span><span class="line"><span class="cl">            <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用Invoke方法来设置进度条  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">RunWithInvoke</span><span class="p">()</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">value</span><span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="c1">//如果是跨线程调用  </span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">SetProgressBarValue</span><span class="p">(</span><span class="n">SetProgressValue</span><span class="p">),</span> <span class="k">value</span><span class="p">++);</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">                <span class="k">else</span>  
</span></span><span class="line"><span class="cl">                <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                    <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="p">++</span><span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">                <span class="p">}</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//跟SetProgressBarValue委托相匹配的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">SetProgressValue</span><span class="p">(</span><span class="kt">int</span> <span class="k">value</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnBackgroundWorker_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BackgroundWorker</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">DoWork</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">DoWorkEventHandler</span><span class="p">(</span><span class="n">worker_DoWork</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//当工作进度发生变化时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">ProgressChanged</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">ProgressChangedEventHandler</span><span class="p">(</span><span class="n">worker_ProgressChanged</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//当事件处理完毕后执行的方法  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">RunWorkerCompleted</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">RunWorkerCompletedEventHandler</span><span class="p">(</span><span class="n">worker_RunWorkerCompleted</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">WorkerReportsProgress</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span><span class="c1">//支持报告进度更新  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">WorkerSupportsCancellation</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span><span class="c1">//不支持异步取消  </span>
</span></span><span class="line"><span class="cl">            <span class="n">worker</span><span class="p">.</span><span class="n">RunWorkerAsync</span><span class="p">();</span><span class="c1">//启动执行  </span>
</span></span><span class="line"><span class="cl">            <span class="n">btnBackgroundWorker</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//当事件处理完毕后执行的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_RunWorkerCompleted</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">RunWorkerCompletedEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">btnBackgroundWorker</span><span class="p">.</span><span class="n">Enabled</span><span class="p">=</span><span class="kc">true</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//当工作进度发生变化时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_ProgressChanged</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ProgressChangedEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//可以在这个方法中与界面进行通讯  </span>
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">ProgressPercentage</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//开始启动工作时执行的事件处理方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">worker_DoWork</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">DoWorkEventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">worker</span><span class="p">.</span><span class="n">ReportProgress</span><span class="p">(++</span><span class="k">value</span><span class="p">);</span><span class="c1">//汇报进度  </span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//使用System.Windows.Forms.Timer来操作界面能  </span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="k">void</span> <span class="n">btnTimer_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">//注意在.net中有多个命名空间下存在Timer类，为了便于区别，使用了带命名空间形式  </span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Timer</span> <span class="n">timer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Windows</span><span class="p">.</span><span class="n">Forms</span><span class="p">.</span><span class="n">Timer</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Interval</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Tick</span> <span class="p">+=</span> <span class="k">new</span> <span class="n">EventHandler</span><span class="p">(</span><span class="n">timer_Tick</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">            <span class="n">timer</span><span class="p">.</span><span class="n">Enabled</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="c1">//Timer中要定期执行的方法  </span>
</span></span><span class="line"><span class="cl">        <span class="k">void</span> <span class="n">timer_Tick</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">        <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="k">value</span> <span class="p">=</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">&lt;</span> <span class="n">progressBar</span><span class="p">.</span><span class="n">Maximum</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">            <span class="p">{</span>  
</span></span><span class="line"><span class="cl">                <span class="n">progressBar</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">+</span><span class="m">100</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  
</span></span><span class="line"><span class="cl">        <span class="p">}</span>  
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl"><span class="p">}</span> </span></span></code></pre></td></tr></table>
</div>
</div><h2 id="task类" class="heading-element"><span>Task类</span>
  <a href="#task%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Task类是封装的一个任务类，内部使用的是ThreadPool类，提供了内建机制，让你知道什么时候异步完成以及如何获取异步执行的结果，并且还能取消异步执行的任务。下面看一个例子是如何使用Task类来执行异步操作的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">((</span><span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="m">10</span><span class="p">);</span><span class="c1">//10为传递的参数C      N0.1</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>no.1处使用Task的构造函数为：</p>
<p><code>public Task( Action&lt;Object&gt; action, Object state )一个Action&lt;Object&gt;</code>类型的委托（即异步调用函数具有一个Object类型的参数），和一个Object类型的参数，也就是传递给异步函数的参数，</p>
<p>Task类还有几种方式的重载，我们还可以传递一些TaskCreationOptions标志来控制Task的执行方式。在这里我使用的是lambda表达去写委托的，这样使得程序的结构更加的清晰，使用Start()来启动异步函数的调用。</p>
<ul>
<li>有返回值，主线程阻塞</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;((</span><span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="m">10</span><span class="p">);</span><span class="c1">//no.1</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Result:{t.Result}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Result</span><span class="p">:</span><span class="m">45</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果任务中出现了异常，那么异常会被吞噬掉，并存储到一个集合中去，而线程可以返回到线程池中去。但是如果在代码中调用了Wait方法或者是Result属性，任务有异常发生就会被引发，不会被吞噬掉。其中Result属性内部本身也调用了Wati方法。Wait方法和上一节中的委托的EndInvoke方法类似，会使得调用线程阻塞直到异步任务完成。</p>
<ul>
<li>取消正在运行的任务
<ul>
<li>取消任务要引用一个CancellationTokenSource 对象。在需要异步执行的方法中增加一个CancellationToken类型的形参。然后在异步函数的for循环代码中用一个if语句判断CancellationToken的CanBeCanceled属性，这个属性可以用来判断在调用线程是否取消任务的执行，</li>
<li>除CanBeCanceled属性之外，还可以使用ThrowIfCancellationRequested方法，该方法的作用是如果在调用线程调用CancellationTokenSource对象的Cancel方法，那么就会引发一个异常，然后在调用线程进行捕捉就好了，这是在异步函数中的处理方式。</li>
<li>no.1在构建任务之前需要建立一个CancellationTokenSource ，</li>
<li>no2.并且把CancellationTokenSource传递给异步调用函数，传递的是CancellationTokenSource对象的Toke属性，该属性是一个CancellationToken类型的对象。这样就完成任务的取消模式，如果想在调用线程中取消任务的执行，只需要调用CancellationTokenSource 的Cancel方法就行啦。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CancellationTokenSource</span> <span class="n">cts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span><span class="c1">//NO.1</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;((</span><span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Sum</span><span class="p">(</span><span class="n">cts</span><span class="p">.</span><span class="n">Token</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">),</span> <span class="m">10</span><span class="p">);</span><span class="c1">//NO.2</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//cts.Cancel();//NO.3如果任务没有完成，但是Task有可能完成了</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">cts</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">Sum</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">ct</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//if (!ct.CanBeCanceled)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">ct</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;任务取消&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//return -1;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="err">结果</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="err">任务取消</span>
</span></span><span class="line"><span class="cl"><span class="err">任务取消</span>
</span></span><span class="line"><span class="cl"><span class="err">任务取消</span>
</span></span><span class="line"><span class="cl"><span class="err">任务取消</span>
</span></span><span class="line"><span class="cl"><span class="err">任务取消</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>主线程不会阻塞
<ul>
<li>前面就说过了，获取任务结果调用Wait方法和Result属性导致调用线程阻塞，那么如何处理这种情况呢，这就使用了<code>Task&lt;TResult&gt;</code>类提供的ContinueWith方法。该方法的作用是当任务完成时，启动一个新的任务，不仅仅是如此，该方法还有可以在任务只出现异常或者取消等情况的时候才执行，只需要给该方法传递TaskContinuationOptions枚举类型就可以了。下面就演示一下如何使用ContinueWith方法。</li>
<li>首先看下ContinueWith方法的原型。</li>
<li><code>public Task ContinueWith( Action&lt;Task&gt; continuationAction )</code>采用一个Action<Task>类型的委托。该方法提供了多种重载的版本，这只是最简单的一种。</li>
<li><code>public Task ContinueWith( Action&lt;Task&gt; continuationAction, TaskContinuationOptions continuationOptions )</code>第二个参数代表新任务的执行条件，当任务满足这个枚举条件才执行 Action<Task>类型的回调函数。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testasy</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="kt">int</span> <span class="n">DoWork</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;((</span><span class="n">c</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Sum</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">c</span><span class="p">),</span> <span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span> <span class="p">=&gt;</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">),</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">);</span><span class="c1">//当任务出现异常时才执行</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">5</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Main Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main Thread done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kt">int</span> <span class="n">Sum</span><span class="p">(</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">$&#34;Asyn Thread:{i}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Asyn Thread Done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Main</span> <span class="n">Thread</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span><span class="p">:</span><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="n">Asyn</span> <span class="n">Thread</span> <span class="n">Done</span></span></span></code></pre></td></tr></table>
</div>
</div><pre><code>+ t.Start()之后调用第一个ContinueWith方法，该方法第一参数就是一个`Action&lt;Task&gt;`的委托类型，相当于是一个回调函数，在这里我也用lambda表达式，当任务完成就会启用一个新任务去执行这个回调函数。而第二个ContinueWith里面的回调方法却不会执行，因为我们的任务也就是Sum方法不会发生异常，不能满足TaskContinuationOptions.OnlyOnFaulted这个枚举条件。**这种用法比委托的异步函数编程看起来要简单些。最关键的是ContinueWith的还有一个重载版本可以带一个TaskScheduler对象参数，该对象负责执行被调度的任务**。
+ FCL中提供两种任务调度器，均派生自TaskScheduler类型：线程池调度器，和同步上下文任务调用器。而在Winform窗体程序设计中TaskScheduler尤为有用，为什么这么说呢？因为在窗体程序中的控件都是有ui线程去创建，而我们所执行的后台任务使用线程都是线程池中的工作线程，所以当我们的任务完成之后需要反馈到Winform控件上，但是控件创建的线程和任务执行的线程不是同一个线程，如果在任务线程中去更新控件就会导致控件对象安全问题会出现异常。所以操作控件，**就必须要使用ui线程去操作。**因此在ContinueWith获取任务执行的结果的并反馈到控件的任务调度上不能使用线程池任务调用器，而要使用同步上下文任务调度器去调度，即采用ui这个线程去调用ContinueWith方法所绑定的回调用函数即`Action&lt;Task&gt;`类型的委托。下面将使用任务调度器来把异步执行的Sum计算结果反馈到Winform界面的TextBox控件中。
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">TaskScheduler</span> <span class="n">contextTaskScheduler</span><span class="p">;</span><span class="c1">//声明一个任务调度器</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Form1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitializeComponent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">contextTaskScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">();</span><span class="c1">//no.1获得一个上下文任务调度器</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;((</span><span class="n">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Sum</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">n</span><span class="p">),</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span> <span class="p">=&gt;</span><span class="k">this</span><span class="p">.</span><span class="n">textBox1</span> <span class="p">.</span><span class="n">Text</span> <span class="p">=</span><span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span><span class="n">contextTaskScheduler</span><span class="p">);</span><span class="c1">//当任务执行完之后执行</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span><span class="p">=&gt;</span><span class="n">MessageBox</span> <span class="p">.</span><span class="n">Show</span> <span class="p">(</span><span class="s">&#34;任务出现异常&#34;</span><span class="p">),</span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span><span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">,</span><span class="n">contextTaskScheduler</span> <span class="p">);</span> <span class="c1">//当任务出现异常时才执行</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">Sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;任务处理完成&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在no.1窗体的构造函数获取该UI线程的同步上下文调度器。在按钮的事件接受异步执行的结果时候，都传递了contextTaskScheduler同步上下文的调度器，目的是，当异步任务完成之后，调度UI线程去执行任务完成之后的回调函数。</p>
<h3 id="多线程ui的例子" class="heading-element"><span>多线程UI的例子</span>
  <a href="#%e5%a4%9a%e7%ba%bf%e7%a8%8bui%e7%9a%84%e4%be%8b%e5%ad%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testthreadui</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">readonly</span> <span class="n">TaskScheduler</span> <span class="n">contextTaskScheduler</span><span class="p">;</span><span class="c1">//声明一个任务调度器</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Form1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitializeComponent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">contextTaskScheduler</span> <span class="p">=</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">();</span><span class="c1">//no.1获得一个上下文任务调度器</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;((</span><span class="n">n</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Sum</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">n</span><span class="p">),</span> <span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">textBox1</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">contextTaskScheduler</span><span class="p">);</span><span class="c1">//当任务执行完之后执行</span>
</span></span><span class="line"><span class="cl">        <span class="n">t</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span> <span class="p">=&gt;</span> <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&#34;任务出现异常&#34;</span><span class="p">),</span> <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">,</span> <span class="n">contextTaskScheduler</span><span class="p">);</span><span class="c1">//当任务出现异常时才执行</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">textBox1</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">textBox2</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">Sum</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">sum</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">sum</span> <span class="p">+=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//throw new Exception(&#34;错误&#34;);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;任务处理完成&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&#34;任务出现异常&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">button2_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">textBox1</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="m">100.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl"><span class="c1">//未发现异常</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>实现实时更新UI</li>
</ul>
<p>首先建立一个winform项目，在主窗体上拖入一个button，一个progressbar，一个lable。如下图所示。</p>
<p><img loading="lazy" src="/dotnet/image-20240701151908591.png" alt="image-20240701151908591" srcset="/dotnet/image-20240701151908591.png?size=small, /dotnet/image-20240701151908591.png?size=medium 1.5x, /dotnet/image-20240701151908591.png?size=large 2x" data-title="image-20240701151908591" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>编写一个处理数据的类（WriteDate），源代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DataWrite</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">UpdateUI</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="p">);</span><span class="c1">//声明一个更新主线程的委托</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UpdateUI</span> <span class="n">UpdateUIDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">AccomplishTask</span><span class="p">();</span><span class="c1">//声明一个在完成任务时通知主线程的委托</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccomplishTask</span> <span class="n">TaskCallBack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Write</span><span class="p">(</span><span class="kt">object</span> <span class="n">lineCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StreamWriter</span> <span class="n">writeIO</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="s">&#34;text.txt&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">GetEncoding</span><span class="p">(</span><span class="s">&#34;gb2312&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">head</span> <span class="p">=</span> <span class="s">&#34;编号,省,市&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeIO</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lineCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeIO</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;,湖南,衡阳&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//写入一条数据，调用更新主线程ui状态的委托</span>
</span></span><span class="line"><span class="cl">            <span class="n">UpdateUIDelegate</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//任务完成时通知主线程作出相应的处理</span>
</span></span><span class="line"><span class="cl">        <span class="n">TaskCallBack</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeIO</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> </span></span></code></pre></td></tr></table>
</div>
</div><p>主界面中的代码如下：</p>
<p>首先要建立一个委托来实现非创建控件的线程更新控件。</p>
<p><code>delegate void AsynUpdateUI(int step); </code></p>
<p>然后编写多线程去启动写入数据的方法以及回调的函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">btnWrite_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">taskCount</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span> <span class="c1">//任务量为10000</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span> <span class="p">=</span> <span class="n">taskCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">DataWrite</span> <span class="n">dataWrite</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DataWrite</span><span class="p">();</span><span class="c1">//实例化一个写入数据的类</span>
</span></span><span class="line"><span class="cl">    <span class="n">dataWrite</span><span class="p">.</span><span class="n">UpdateUIDelegate</span> <span class="p">+=</span> <span class="n">UpdataUIStatus</span><span class="p">;</span><span class="c1">//绑定更新任务状态的委托</span>
</span></span><span class="line"><span class="cl">    <span class="n">dataWrite</span><span class="p">.</span><span class="n">TaskCallBack</span> <span class="p">+=</span> <span class="n">Accomplish</span><span class="p">;</span><span class="c1">//绑定完成任务要调用的委托</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">dataWrite</span><span class="p">.</span><span class="n">Write</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">thread</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">taskCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//更新UI</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">UpdataUIStatus</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">	        <span class="k">this</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">AsynUpdateUI</span><span class="p">(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">+=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">lblWriteStatus</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}),</span> <span class="n">step</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">+=</span> <span class="n">step</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">lblWriteStatus</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//完成任务时需要调用</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="k">void</span> <span class="n">Accomplish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//还可以进行其他的一些完任务完成之后的逻辑处理</span>
</span></span><span class="line"><span class="cl">    <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&#34;任务完成&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> </span></span></code></pre></td></tr></table>
</div>
</div><p>完整代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C#" data-lang="C#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Windows.Forms</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">testthreadui</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">partial</span> <span class="k">class</span> <span class="nc">Form1</span> <span class="p">:</span> <span class="n">Form</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">delegate</span> <span class="k">void</span> <span class="n">AsynUpdateUI</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Form1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">InitializeComponent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">button1_Click</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">taskCount</span> <span class="p">=</span> <span class="m">10000</span><span class="p">;</span> <span class="c1">//任务量为10000</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span> <span class="p">=</span> <span class="n">taskCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DataWrite</span> <span class="n">dataWrite</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DataWrite</span><span class="p">();</span><span class="c1">//实例化一个写入数据的类</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataWrite</span><span class="p">.</span><span class="n">UpdateUIDelegate</span> <span class="p">+=</span> <span class="n">UpdataUIStatus</span><span class="p">;</span><span class="c1">//绑定更新任务状态的委托</span>
</span></span><span class="line"><span class="cl">        <span class="n">dataWrite</span><span class="p">.</span><span class="n">TaskCallBack</span> <span class="p">+=</span> <span class="n">Accomplish</span><span class="p">;</span><span class="c1">//绑定完成任务要调用的委托</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="n">thread</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">ParameterizedThreadStart</span><span class="p">(</span><span class="n">dataWrite</span><span class="p">.</span><span class="n">Write</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">thread</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">thread</span><span class="p">.</span><span class="n">Start</span><span class="p">(</span><span class="n">taskCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">UpdataUIStatus</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">InvokeRequired</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="n">AsynUpdateUI</span><span class="p">(</span><span class="k">delegate</span> <span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">+=</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="n">lblWriteStatus</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}),</span> <span class="n">step</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span> <span class="p">+=</span> <span class="n">step</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">lblWriteStatus</span><span class="p">.</span><span class="n">Text</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span> <span class="p">+</span> <span class="k">this</span><span class="p">.</span><span class="n">pgbWrite</span><span class="p">.</span><span class="n">Maximum</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//完成任务时需要调用</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="k">void</span> <span class="n">Accomplish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//还可以进行其他的一些完任务完成之后的逻辑处理</span>
</span></span><span class="line"><span class="cl">        <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&#34;任务完成&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">DataWrite</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">UpdateUI</span><span class="p">(</span><span class="kt">int</span> <span class="n">step</span><span class="p">);</span><span class="c1">//声明一个更新主线程的委托</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">UpdateUI</span> <span class="n">UpdateUIDelegate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">delegate</span> <span class="k">void</span> <span class="n">AccomplishTask</span><span class="p">();</span><span class="c1">//声明一个在完成任务时通知主线程的委托</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AccomplishTask</span> <span class="n">TaskCallBack</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">void</span> <span class="n">Write</span><span class="p">(</span><span class="kt">object</span> <span class="n">lineCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">StreamWriter</span> <span class="n">writeIO</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StreamWriter</span><span class="p">(</span><span class="s">&#34;text.txt&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">GetEncoding</span><span class="p">(</span><span class="s">&#34;gb2312&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">head</span> <span class="p">=</span> <span class="s">&#34;编号,省,市&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeIO</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lineCount</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">writeIO</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;,湖南,衡阳&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//写入一条数据，调用更新主线程ui状态的委托</span>
</span></span><span class="line"><span class="cl">            <span class="n">UpdateUIDelegate</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//任务完成时通知主线程作出相应的处理</span>
</span></span><span class="line"><span class="cl">        <span class="n">TaskCallBack</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">writeIO</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2018-11-23 17:09:22">更新于 2018-11-23&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0 转载请注明来源</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="https://github.com/DDuuuu/issues/new?title=[BUG]%20DotNet%E5%9F%BA%E7%A1%80&#43;%E7%BA%BF%E7%A8%8B&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cDotNet%E5%9F%BA%E7%A1%80&#43;%E7%BA%BF%E7%A8%8B%7c%0A%7cURL%7chttps://DDuuuu.github.io/2018/11/dotnetbase4-thread/%7c%0A%7cFilename%7c%7c" title="报告问题"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">报告问题</a></span></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/dotnet%E5%9F%BA%E7%A1%80/" class="post-tag" title="标签 - DotNet基础">DotNet基础</a><a href="/tags/%E7%BA%BF%E7%A8%8B/" class="post-tag" title="标签 - 线程">线程</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/2018/11/dotnetbase2-sql-adonet/" class="post-nav-item" rel="prev" title="DotNet基础 入门"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>DotNet基础 入门</a>
      <a href="/2018/12/dotnetbase5-winform/" class="post-nav-item" rel="next" title="DotNet基础 Winform">DotNet基础 Winform<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div class="post-reward">
    <div class="comment">为爱发电,请我喝杯咖啡吧</div>
    <input type="checkbox" class="reward-input" name="reward" id="fi-reward" hidden />
    <label class="reward-button" for="fi-reward"><i class="fa-solid fa-qrcode fa-fw" aria-hidden="true"></i>赞赏</label>
    <div class="reward-ways" data-mode="static"><div><img loading="lazy" src="/images/alipay.jpg" alt="AndrewDu 支付宝" data-title="AndrewDu 支付宝" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>支付宝</span>
          </div><div><img loading="lazy" src="/images/wechat.jpg" alt="AndrewDu 微信" data-title="AndrewDu 微信" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>微信</span>
          </div></div>
  </div><div id="comments"><div id="artalk" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/ArtalkJS/Artalk" rel="external nofollow noopener noreferrer">Artalk</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2018 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/DDuuuu"target="_blank" rel="external nofollow noopener noreferrer">AndrewDu</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="ms-1 d-none">网站运行时间:</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><a href="https://github.com/DDuuuu" title="AndrewDu GitHub"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;bottom: 0;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="http://175.24.188.254:2240/dist/Artalk.css"><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/object-fit-images/ofi.min.js"></script><script src="http://175.24.188.254:2240/dist/Artalk.js"></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","maxShownLines":999999},"comment":{"artalk":{"countEl":"artalk-comment-count","editorTravel":true,"el":"#artalk","flatMode":"auto","gravatar":{"mirror":"https://www.gravatar.com/avatar/","params":"d=\u0026s=240"},"locale":"zh-CN","nestMax":2,"nestSort":"DATE_ASC","pageKey":"https://DDuuuu.github.io/2018/11/dotnetbase4-thread/","pageTitle":"DotNet基础 线程","pvEl":"artalk-visitor-count","server":"http://175.24.188.254:2240","site":"默认站点","useBackendConf":false},"enable":true,"expired":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":12,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":100,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"siteTime":"2018-02-22T04:10:22+08:00","twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.8","watermark":{"colspacing":300,"content":"Andrew.Du","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":20,"opacity":0.1,"rotate":15,"rowspacing":300,"width":150}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
