<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>NetCLRVia 同步与竞争 - AndrewDu&#39;s blog</title><meta name="author" content="AndrewDu">
<meta name="author-link" content="https://github.com/DDuuuu">
<meta name="description" content="基元线程同步构造 构建可伸缩的，响应灵敏的应用程序，关键在于不要阻塞线程， 多个线程同时访问共享数据，获取并释放一个线程同步锁。锁会损害性能，获" /><meta name="keywords" content='NetCLRVia, 同步与竞争' />
  <meta itemprop="name" content="NetCLRVia 同步与竞争">
  <meta itemprop="description" content="基元线程同步构造 构建可伸缩的，响应灵敏的应用程序，关键在于不要阻塞线程， 多个线程同时访问共享数据，获取并释放一个线程同步锁。锁会损害性能，获">
  <meta itemprop="datePublished" content="2020-03-01T17:09:22+08:00">
  <meta itemprop="dateModified" content="2020-03-01T17:09:22+08:00">
  <meta itemprop="wordCount" content="15318">
  <meta itemprop="image" content="https://DDuuuu.github.io/images/logo150.png">
  <meta itemprop="keywords" content="NetCLRVia,同步与竞争"><meta property="og:url" content="https://DDuuuu.github.io/2020/03/dotnetbase8-netclrvia/">
  <meta property="og:site_name" content="AndrewDu&#39;s blog">
  <meta property="og:title" content="NetCLRVia 同步与竞争">
  <meta property="og:description" content="基元线程同步构造 构建可伸缩的，响应灵敏的应用程序，关键在于不要阻塞线程， 多个线程同时访问共享数据，获取并释放一个线程同步锁。锁会损害性能，获">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-03-01T17:09:22+08:00">
    <meta property="article:modified_time" content="2020-03-01T17:09:22+08:00">
    <meta property="article:tag" content="NetCLRVia">
    <meta property="article:tag" content="同步与竞争">
    <meta property="og:image" content="https://DDuuuu.github.io/images/logo150.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://DDuuuu.github.io/images/logo150.png">
  <meta name="twitter:title" content="NetCLRVia 同步与竞争">
  <meta name="twitter:description" content="基元线程同步构造 构建可伸缩的，响应灵敏的应用程序，关键在于不要阻塞线程， 多个线程同时访问共享数据，获取并释放一个线程同步锁。锁会损害性能，获">
<meta name="application-name" content="Andrew.Du">
<meta name="apple-mobile-web-app-title" content="Andrew.Du"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://DDuuuu.github.io/2020/03/dotnetbase8-netclrvia/" /><link rel="prev" href="https://DDuuuu.github.io/2020/02/dotnetbase7-netclrvia/" /><link rel="next" href="https://DDuuuu.github.io/2020/03/prism15-source/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "NetCLRVia 同步与竞争",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/DDuuuu.github.io\/2020\/03\/dotnetbase8-netclrvia\/"
    },"image": ["https:\/\/DDuuuu.github.io\/images\/logo192.png"],"genre": "posts","keywords": "NetCLRVia, 同步与竞争","wordcount":  15318 ,
    "url": "https:\/\/DDuuuu.github.io\/2020\/03\/dotnetbase8-netclrvia\/","datePublished": "2020-03-01T17:09:22+08:00","dateModified": "2020-03-01T17:09:22+08:00","license": "Copyright© Andrew.Du","publisher": {
      "@type": "Organization",
      "name": "AndrewDu"},"author": {
        "@type": "Person",
        "name": "AndrewDu"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="AndrewDu&#39;s blog"><span class="typeit"><template>AndrewDu&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/"
                title="主页"
                
              ><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden="true"></i> 主页</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/archives/"
                title="归档"
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 类别</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="AndrewDu&#39;s blog"><span class="typeit"><template>AndrewDu&#39;s blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/"
                  title="主页"
                  
                ><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden="true"></i> 主页</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/archives/"
                  title="归档"
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 类别</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-link fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="AndrewDu&#39;s Blog">主页</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">文章</a></li><li class="breadcrumb-item active" aria-current="page">NetCLRVia 同步与竞争</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>NetCLRVia 同步与竞争</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/DDuuuu" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
    AndrewDu</a></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/netclrvia/" class="post-category" title="分类 - NetCLRVia"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> NetCLRVia</a></span></div><div class="post-meta-line"><span title="发布于 2020-03-01 17:09:22"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2020-03-01">2020-03-01</time></span>&nbsp;<span title="15318 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 15400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 31 分钟</span>&nbsp;<span class="comment-visitors" data-flag-title="NetCLRVia 同步与竞争">
              <i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span class="artalk-visitor-count" data-page-key="/2020/03/dotnetbase8-netclrvia/">-</span>&nbsp;次阅读
            </span>&nbsp;<span class="comment-count" data-flag-title="NetCLRVia 同步与竞争">
              <i class="fa-regular fa-comments fa-fw me-1" aria-hidden="true"></i><span class="artalk-comment-count" data-page-key="/2020/03/dotnetbase8-netclrvia/">-</span>&nbsp;条评论
            </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#基元线程同步构造">基元线程同步构造</a>
      <ul>
        <li><a href="#类库和线程安全">类库和线程安全</a></li>
        <li><a href="#基元用户模式和内核模式构造">基元用户模式和内核模式构造</a></li>
        <li><a href="#用户模式构造">用户模式构造</a>
          <ul>
            <li><a href="#易变构造volatile-construct">易变构造(Volatile Construct)</a></li>
            <li><a href="#互锁构造">互锁构造</a></li>
            <li><a href="#使用互锁构造的webclient例子">使用互锁构造的WebClient例子。</a></li>
            <li><a href="#简单自旋锁spin-lock">简单自旋锁(spin lock)</a></li>
            <li><a href="#在线程中引入延迟">在线程中引入延迟</a>
              <ul>
                <li><a href="#sleep">Sleep</a></li>
                <li><a href="#yield">Yield</a></li>
              </ul>
            </li>
            <li><a href="#interlocked-anything">Interlocked Anything</a></li>
          </ul>
        </li>
        <li><a href="#内核模式构造">内核模式构造</a>
          <ul>
            <li><a href="#event">Event</a></li>
            <li><a href="#semaphore构造">Semaphore构造</a></li>
            <li><a href="#mutex">Mutex</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#混合线程同步构造">混合线程同步构造</a>
      <ul>
        <li><a href="#一个简单混合锁">一个简单混合锁</a></li>
        <li><a href="#自旋线程所有权和递归">自旋、线程所有权和递归</a></li>
        <li><a href="#fcl中的混合构造">FCL中的混合构造</a>
          <ul>
            <li><a href="#manualreseteventslim和semaphoreslim">ManualResetEventSlim和SemaphoreSlim</a></li>
            <li><a href="#monitor和同步块">Monitor和同步块</a></li>
            <li><a href="#readwritelockslim类">ReadWriteLockSlim类</a></li>
            <li><a href="#onemanylock类">OneManyLock类</a></li>
            <li><a href="#countdownevent类">CountdownEvent类</a></li>
            <li><a href="#barrier类">Barrier类</a></li>
            <li><a href="#线程同步构造小结">线程同步构造小结</a></li>
          </ul>
        </li>
        <li><a href="#著名的双检锁技术">著名的双检锁技术</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="感谢阅读！"><h2 id="基元线程同步构造" class="heading-element"><span>基元线程同步构造</span>
  <a href="#%e5%9f%ba%e5%85%83%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>构建可伸缩的，响应灵敏的应用程序，关键在于不要阻塞线程，</p>
<p>多个线程同时访问共享数据，获取并释放一个线程同步锁。锁会损害性能，获取和释放锁是需要时间的。只允许一个线程访问共享资源，可以使用值类型，多个线程对共享数据进行只读访问是没有任何问题的。</p>
<h3 id="类库和线程安全" class="heading-element"><span>类库和线程安全</span>
  <a href="#%e7%b1%bb%e5%ba%93%e5%92%8c%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><strong>FCL保证所有静态方法都是线程安全的</strong>。多个线程调用同一个静态方法，并不是说方法内部会获取一个同步锁，也可能内部数据是值类型。</p>
<p>FCL没有保证实例方法是线程安全的。</p>
<p>所有的静态方法都是线程安全的，所有实例方法都是非线程安全。</p>
<h3 id="基元用户模式和内核模式构造" class="heading-element"><span>基元用户模式和内核模式构造</span>
  <a href="#%e5%9f%ba%e5%85%83%e7%94%a8%e6%88%b7%e6%a8%a1%e5%bc%8f%e5%92%8c%e5%86%85%e6%a0%b8%e6%a8%a1%e5%bc%8f%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>基元：primitive,</p>
<p>基元用户模式的速度要显著高于基元内核模式，因为其使用特殊的CPU指令来协调线程，<strong>缺点是操作系统用还不会察觉线程在基元用户模式的构造上阻塞了，也就永远不会创建新线程来替换阻塞线程。</strong></p>
<p>基元用户模式中操作系统内核才能停止一个线程的运行，<strong>用户模式中线程可能被系统抢占(preempted)，但会以最快的速度被调用</strong>，如果暂时取不到的线程会一直处于自旋状态，这可能浪费大量CPU时间。</p>
<p>从上面可以看出基元用户模式跟CPU有关，是CPU提供的</p>
<p>基元内核模式是由操作系统提供的。在应用程序的线程中调用操作系统内核实现函数。用户模式切换为内核模式会造成巨大的损失。但内核模式的优点是：线程获取其他线程拥有的资源时，Windows会阻塞线程避免它浪费CPU时间。当资源可用时，Windows恢复线程，允许它访问资源。</p>
<p>在构造上等待的线程，如果是用户模式，线程将一直在CPU上运行，称为&quot;活锁“。如果是内核模式，线程将一直阻塞，称为&quot;死锁&quot;(deadlock)，但比较而言，死锁总是由于活锁，因为活锁既浪费CPU也浪费内存。</p>
<p>所以最好的构造方式应该是混合构造(hybrid construct)，在大多数时间运行的很快，偶尔运行的比较慢。</p>
<p>CLR中的线程同步构造实际是”Win32线程同步构造“的包装器，CLR线程就是Windows线程，Windows调度线程和控制线程同步。</p>
<h3 id="用户模式构造" class="heading-element"><span>用户模式构造</span>
  <a href="#%e7%94%a8%e6%88%b7%e6%a8%a1%e5%bc%8f%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>CLR可以保证对Boolean,Char,(S)Byte,(U)Int16,(U)Int32,(U)IntPtr,Single以及<strong>引用类型</strong>的读写是<strong>原子性的，也就是一次性读写。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">SomeType</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">x</span><span class="p">=</span><span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//线程执行这一行代码，</span>
</span></span><span class="line"><span class="cl"><span class="n">SomeType</span><span class="p">.</span><span class="n">x</span><span class="p">=</span><span class="m">0x01234567</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>x变量会一次性从0x000000变成0x12345，另一个线程不可能看到中间状态的值，也不可能有别的线程访问。如果该类型是Int64，别的线程就有可能获得中间状态的值，其实是分为两个Move指令才能读完。</p>
<p>两种基元用户模式线程同步构造：</p>
<ul>
<li>易变构造(volatile construct):在特定时间，在一个简单数据类型的变量上执行原子读或写操作。</li>
<li>互锁构造(interlocked construct)：和上面相同</li>
</ul>
<p>易变和互锁构造都要求传递包含简单数据类型的内存地址。</p>
<h4 id="易变构造volatile-construct" class="heading-element"><span>易变构造(Volatile Construct)</span>
  <a href="#%e6%98%93%e5%8f%98%e6%9e%84%e9%80%a0volatile-construct" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>C#编译器将C#代码转换成IL，JIT将IL转换成CPU指令，C#编译器，JIT编译器，CPU都有可能优化代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">OptimizedAway</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// An expression of constants is computed at compile time then put into a local variable that is never used</span>
</span></span><span class="line"><span class="cl">      <span class="n">Int32</span> <span class="k">value</span> <span class="p">=</span> <span class="m">1</span> <span class="p">*</span> <span class="m">100</span> <span class="p">+</span> <span class="m">0</span> <span class="p">/</span> <span class="m">1</span> <span class="p">%</span> <span class="m">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">)</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Jeff&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="m">1000</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span> <span class="p">;</span>   <span class="c1">// A loop that does nothing</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>下面代码编译后会优化掉很多东西。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">StrangeBehavior</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Compile with &#34;/platform:x86 /o&#34; and run it NOT under the debugger (Ctrl+F5)</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">s_stopWorker</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Go</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main: letting worker run for 5 seconds&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">Worker</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">5000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">s_stopWorker</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Main: waiting for worker to stop&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">t</span><span class="p">.</span><span class="n">Join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">Environment</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Worker</span><span class="p">(</span><span class="n">Object</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Int32</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">while</span> <span class="p">(!</span><span class="n">s_stopWorker</span><span class="p">)</span> <span class="n">x</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Worker: stopped when x={0}&#34;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Main中创建一个新线程来执行Worker方法，在/platform:x86和/optimize+开关编译(x86 JIT编译器比x64编译器更程数，所以它执行优化的时候更大胆)，会对代码进行优化，当编译器发现worker中s_stopWorker永远不发生变化，编译器会生成代码检查s_stopWorker。如果为false，就进入无线循环，一直递增x，<strong>优化后，s_stopWorker检查只在循环前发生一次，不会每次迭代都检查。</strong></p>
<p>针对编译器和CPU的优化，FCL提供了两个静态方法，<strong>禁止一些优化</strong>，<strong>System.Threading.Volatile</strong>类提供了两个静态方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">ThreadsSharingData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">ThreadsSharingDataV1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_flag</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 这个方法由一个线程执行</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: 以下两行代码可以按相反的顺序执行</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_flag</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 这个方法由另一个线程执行 </span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: m_value 可能先于 m_flag 读取</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">m_flag</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>编译器和CPU解释优化代码的时候可能会反转Thread1()方法中的两行代码，在单线程顺序执行的时候，Thread1()，Thread2()优化并不会产生问题，但是多线程的时候，如果允许多线线程同时读写数据就会产生很多问题，<strong>针对Thread1方法必须要保证m_value和m_flag，同时执行写入，在写入的时候，所有读取线程停止，写完再允许读</strong>，<strong>针对Thread2方法必须要保证先读取m_flag值在读取m_value值，在2个变量读取的时候禁止所有写入操作</strong>。</p>
<p>System.Threading.Volatile是如何解决这些问题的，静态方法，原子操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">Volatile</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Write</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location</span><span class="p">,</span><span class="n">Int32</span> <span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Read</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Volatile.Write方法强迫location中的值在调用时写入，按照编码顺序，之前加载和存储操作必须在调用Volatile.Write之前发生。</li>
<li>Volatile.Read方法强迫location中的值在调用时读取，按照编码顺序，之后加载和存储操作必须在调用Volatile.Read之后发生。</li>
</ul>
<p>总结：<strong>当线程通过共享内存相互通信时，调用Volatile.Write来写入最后一个值，调用Volatile.Read读取第一个值。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">ThreadsSharingDataV2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_flag</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 这个方法由一个线程执行</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: 在将1写入m_flag之前，必须先将5写入m_value.</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Volatile</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_flag</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 这个方法由另一个线程执行 </span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: m_value必然在读取 m_flag 之后读取</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Volatile</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_flag</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>C#对Volatile的支持，为了简化编程，c#提供了volatile关键字，可应用于以下类型，Boolean,(S)Byte,(U)Int16，(U)Int32,(U)IntPtr,Single,Char和引用类型。Volatile关键字高速C#和JIT编译器不讲字段缓存到CPU寄存器，确保字段所有读写操作都是在RAM中执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">ThreadsSharingDataV3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//非常重要</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Int32</span> <span class="n">m_flag</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_value</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method is executed by one thread </span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: 5 must be written to m_value before 1 is written to m_flag</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_value</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_flag</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method is executed by another thread </span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Thread2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Note: m_value must be read after m_flag is read </span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">m_flag</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">m_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这种优化的方式也有一些缺陷。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="n">m_amount</span> <span class="p">=</span> <span class="n">m_amout</span> <span class="p">+</span> <span class="n">m_amout</span><span class="p">;</span><span class="c1">//假定m_amout是类定义的一个volatile字段</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果优化，m_amout左移1位就可以了，如果不允许这个优化，会对性能造成很大影响，同时一旦使用了m_amount就不允许其值传递自己的引用。</p>
<h4 id="互锁构造" class="heading-element"><span>互锁构造</span>
  <a href="#%e4%ba%92%e9%94%81%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Volatile的方法都是原子性操作。而System.Threading.Interlocked类提供的方法也是<strong>执行原子操作</strong>，同时建立了完整的<strong>内存栅栏</strong>(memory fence),Volatile有的都有。</p>
<p>简单来说就是：调用某个Interlocked方法之前的任何变量写入都在这个Interlocked方法调用前执行，调用之后的任何变量读取都在这个调用之后读取。<strong>静态方法，原子操作</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">Interlocked</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return (++location)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return (--location)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location</span><span class="p">)</span><span class="err">；</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return (location+=value)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//notes:value可能是一个负数，从而实现剑法运算</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Add</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location1</span><span class="p">,</span><span class="n">Int32</span> <span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Int32 old = location; location=value;reurn old</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Exchange</span><span class="p">(</span><span class="n">retf</span> <span class="n">Int32</span> <span class="n">location1</span><span class="p">,</span><span class="n">Int32</span> <span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Int32 old = location1;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//if (location1==comparand) location1=value;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//return old;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">location1</span><span class="p">,</span><span class="n">Int32</span> <span class="k">value</span><span class="p">,</span><span class="n">Int32</span> <span class="n">comparand</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用互锁构造的webclient例子" class="heading-element"><span>使用互锁构造的WebClient例子。</span>
  <a href="#%e4%bd%bf%e7%94%a8%e4%ba%92%e9%94%81%e6%9e%84%e9%80%a0%e7%9a%84webclient%e4%be%8b%e5%ad%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="c1">//调用go</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">AsyncCoordinatorDemo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Go</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">const</span> <span class="n">Int32</span> <span class="n">timeout</span> <span class="p">=</span> <span class="m">50000</span><span class="p">;</span>   <span class="c1">// Change to desired timeout</span>
</span></span><span class="line"><span class="cl">      <span class="n">MultiWebRequests</span> <span class="n">act</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MultiWebRequests</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;All operations initiated (Timeout={0}). Hit &lt;Enter&gt; to cancel.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">timeout</span> <span class="p">==</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">)</span> <span class="p">?</span> <span class="s">&#34;Infinite&#34;</span> <span class="p">:</span> <span class="p">(</span><span class="n">timeout</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span> <span class="p">+</span> <span class="s">&#34;ms&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">act</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Hit enter to terminate.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">MultiWebRequests</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// This helper class coordinates all the asynchronous operations</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">AsyncCoordinator</span> <span class="n">m_ac</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AsyncCoordinator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Set of Web servers we want to query &amp; their responses (Exception or Int32)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="p">&gt;</span> <span class="n">m_servers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span> <span class="s">&#34;https://www.zhihu.com/&#34;</span><span class="p">,</span> <span class="kc">null</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span> <span class="s">&#34;https://www.cnblogs.com/&#34;</span><span class="p">,</span>  <span class="kc">null</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">         <span class="p">{</span> <span class="s">&#34;https://1.1.1.1&#34;</span><span class="p">,</span>        <span class="kc">null</span> <span class="p">}</span> 
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">MultiWebRequests</span><span class="p">(</span><span class="n">Int32</span> <span class="n">timeout</span> <span class="p">=</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Asynchronously initiate all the requests all at once</span>
</span></span><span class="line"><span class="cl">         <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">server</span> <span class="k">in</span> <span class="n">m_servers</span><span class="p">.</span><span class="n">Keys</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_ac</span><span class="p">.</span><span class="n">AboutToBegin</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">httpClient</span><span class="p">.</span><span class="n">GetByteArrayAsync</span><span class="p">(</span><span class="n">server</span><span class="p">).</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">task</span> <span class="p">=&gt;</span> <span class="n">ComputeResult</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">task</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Tell AsyncCoordinator that all operations have been initiated and to call</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// AllDone when all operations complete, Cancel is called, or the timeout occurs</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_ac</span><span class="p">.</span><span class="n">AllBegun</span><span class="p">(</span><span class="n">AllDone</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">void</span> <span class="n">ComputeResult</span><span class="p">(</span><span class="n">String</span> <span class="n">server</span><span class="p">,</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Byte</span><span class="p">[]&gt;</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Object</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">Exception</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">InnerException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Process I/O completion here on thread pool thread(s)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Put your own compute-intensive algorithm here...</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>   <span class="c1">// This example just returns the length</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Save result (exception/sum) and indicate that 1 operation completed</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_servers</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="p">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_ac</span><span class="p">.</span><span class="n">JustEnded</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Calling this method indicates that the results don&#39;t matter anymore</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Cancel</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_ac</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method is called after all Web servers respond, </span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Cancel is called, or the timeout occurs</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">void</span> <span class="n">AllDone</span><span class="p">(</span><span class="n">CoordinationStatus</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">Cancel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Operation canceled.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">Timeout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Operation timed-out.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">AllDone</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Operation completed; results below:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">server</span> <span class="k">in</span> <span class="n">m_servers</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;{0} &#34;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">Key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Object</span> <span class="n">result</span> <span class="p">=</span> <span class="n">server</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;failed due to {0}.&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;returned {0:N0} bytes.&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">enum</span> <span class="n">CoordinationStatus</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">AllDone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">Timeout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">Cancel</span>
</span></span><span class="line"><span class="cl">   <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">AsyncCoordinator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_opCount</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>        <span class="c1">// Decremented when AllBegun calls JustEnded</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_statusReported</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="c1">// 0=false, 1=true</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Action</span><span class="p">&lt;</span><span class="n">CoordinationStatus</span><span class="p">&gt;</span> <span class="n">m_callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Timer</span> <span class="n">m_timer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method MUST be called BEFORE initiating an operation</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">AboutToBegin</span><span class="p">(</span><span class="n">Int32</span> <span class="n">opsToAdd</span> <span class="p">=</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Interlocked</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_opCount</span><span class="p">,</span> <span class="n">opsToAdd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method MUST be called AFTER an operations result has been processed</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">JustEnded</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_opCount</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReportStatus</span><span class="p">(</span><span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">AllDone</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This method MUST be called AFTER initiating ALL operations</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">AllBegun</span><span class="p">(</span><span class="n">Action</span><span class="p">&lt;</span><span class="n">CoordinationStatus</span><span class="p">&gt;</span> <span class="n">callback</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">timeout</span> <span class="p">=</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_callback</span> <span class="p">=</span> <span class="n">callback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="p">!=</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_timer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Timer</span><span class="p">(</span><span class="n">TimeExpired</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="n">JustEnded</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">void</span> <span class="n">TimeExpired</span><span class="p">(</span><span class="n">Object</span> <span class="n">o</span><span class="p">)</span> <span class="p">{</span> <span class="n">ReportStatus</span><span class="p">(</span><span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">Timeout</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Cancel</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">m_callback</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="s">&#34;Cancel cannot be called before AllBegun&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="n">ReportStatus</span><span class="p">(</span><span class="n">CoordinationStatus</span><span class="p">.</span><span class="n">Cancel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">void</span> <span class="n">ReportStatus</span><span class="p">(</span><span class="n">CoordinationStatus</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">m_timer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// If timer is still in play, kill it</span>
</span></span><span class="line"><span class="cl">            <span class="n">Timer</span> <span class="n">timer</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">Exchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_timer</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="n">timer</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// If status has never been reported, report it; else ignore it</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Exchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_statusReported</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_callback</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//结果</span>
</span></span><span class="line"><span class="cl"><span class="n">All</span> <span class="n">operations</span> <span class="n">initiated</span> <span class="p">(</span><span class="n">Timeout</span><span class="p">=</span><span class="m">50000</span><span class="n">ms</span><span class="p">).</span> <span class="n">Hit</span> <span class="p">&lt;</span><span class="n">Enter</span><span class="p">&gt;</span> <span class="n">to</span> <span class="n">cancel</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Operation</span> <span class="n">completed</span><span class="p">;</span> <span class="n">results</span> <span class="n">below</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="c1">//www.zhihu.com/ returned 52,010 bytes.</span>
</span></span><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="c1">//www.cnblogs.com/ returned 48,437 bytes.</span>
</span></span><span class="line"><span class="cl"><span class="n">https</span><span class="p">:</span><span class="c1">//1.1.1.1 returned 44,241 bytes.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Hit</span> <span class="n">enter</span> <span class="n">to</span> <span class="n">terminate</span><span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个例子是通过异步的方式请求几个服务器，计算每个服务器返回的数据量。这个例子不阻塞任何线程，使用线程池来实现自动伸缩。</p>
<ul>
<li>
<p>初始化AsyncCoordinator和数据字典</p>
</li>
<li>
<p>通过异步方式遍历所有字典，并使用ContinueWith,没遍历一项就调用AboutToBegin计数</p>
</li>
<li>
<p>全部遍历完调用AllBegun，设置定时器时间，回调函数。</p>
</li>
<li>
<p>ContinueWith中，调用JustEnded减计数器。</p>
</li>
<li>
<p>当计数器减到0或定时器时间到，调用回调函数。</p>
</li>
<li>
<p>m_opCount字段初始化1，非常重要，可以保证在调用AllBegun之前不会调用AllDone。</p>
</li>
</ul>
<h4 id="简单自旋锁spin-lock" class="heading-element"><span>简单自旋锁(spin lock)</span>
  <a href="#%e7%ae%80%e5%8d%95%e8%87%aa%e6%97%8b%e9%94%81spin-lock" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="c1">//定义 </span>
</span></span><span class="line"><span class="cl"><span class="kd">internal</span> <span class="k">struct</span> <span class="nc">SimpleSpinLock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_ResourceInUse</span><span class="p">;</span> <span class="c1">// 0=false (default), 1=true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 总是将资源设为正在使用</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 只有从未使用编程正在使用才返回</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Exchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_ResourceInUse</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 这里添加黑科技</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 资源标记为未使用</span>
</span></span><span class="line"><span class="cl">         <span class="n">Volatile</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_ResourceInUse</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//使用</span>
</span></span><span class="line"><span class="cl"><span class="n">SimpleSpinLock</span> <span class="n">ssl</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleSpinLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ssl</span><span class="p">.</span><span class="n">Enter</span><span class="p">();</span> <span class="n">x</span><span class="p">++;</span> <span class="n">ssl</span><span class="p">.</span><span class="n">Leave</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>简单解释一下：当两个线程一起调用Enter的时候，那么Interlocked.Exchange会确保一个线程将m_ResourceInUse从0变成1，并发现m_ResourceInUse原来是0，就直接return；然后才能执行业务代码。另一个线程m_ResourceInUse从1变成1，不是由0变成1，会不停调用Exchange进行自旋，直到第一个线程调用Leave。</p>
<p>自旋锁最大的问题在于：对锁竞争的前提下，自旋会浪费宝贵的CPU时间。在单CPU机器上使用，如果占有锁的线程优先级低于想要获取锁的优先级，会使得占有锁线程根本没有机会运行。可以在黑科技中取消优先级。</p>
<p>FCL提供了一个System.Threading.SpinWait结构，封装了黑科技的最新研究成果。还有System.Threading.SpinLock结构，内部使用了SpinWait结构，同时还提供了超时支持。</p>
<p>注意锁是<strong>值类型</strong>，不要传递SpinLock实例，会被复制，否则会失去同步。</p>
<h4 id="在线程中引入延迟" class="heading-element"><span>在线程中引入延迟</span>
  <a href="#%e5%9c%a8%e7%ba%bf%e7%a8%8b%e4%b8%ad%e5%bc%95%e5%85%a5%e5%bb%b6%e8%bf%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>黑科技是自旋的线程暂停执行，也就是不占用CPU时间，使拥有资源的线程能执行代码，内部调用Sleep,Yield和SpinWait方法。</p>
<h5 id="sleep" class="heading-element"><span>Sleep</span>
  <a href="#sleep" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Sleep</span><span class="p">(</span><span class="n">Int32</span> <span class="n">millisecondsTimeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Sleep</span><span class="p">(</span><span class="n">TimeSpan</span> <span class="n">timeout</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>时间到了后不会准时唤起线程。</p>
<p>传入System.Threading.Timeout.Infinite（-1）,永远不会调度线程（没意义最好退出线程，会输栈和内核对象），传入0，线程放弃当前时间片，强迫调用另一个线程，也可能会再一次调用自己。</p>
<h5 id="yield" class="heading-element"><span>Yield</span>
  <a href="#yield" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><p>调度另一个线程是Thread.Yield方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">Yield</span><span class="p">();</span></span></span></code></pre></td></tr></table>
</div>
</div><p>windows发现另一个线程准备好，Yield就返回true,在发现的线程上运行一个时间片，然后再回来。</p>
<h4 id="interlocked-anything" class="heading-element"><span>Interlocked Anything</span>
  <a href="#interlocked-anything" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Interlocked没有提供Multiple，divide,Minimum,and,or,xor等方法,可以使用Interlocked.CompareExchange方法可以再Int32上执行任何操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">Maximum</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">,</span><span class="n">Int32</span> <span class="k">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int32</span> <span class="n">currentVal</span><span class="p">=</span><span class="n">target</span><span class="p">,</span><span class="n">startVal</span><span class="p">,</span><span class="n">desireVal</span><span class="p">;</span><span class="c1">//</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//不要再循环中访问目标(target),除非是想要改变它时另一个线程也在动它</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//记录这一次循环迭代的起始值(startVal)</span>
</span></span><span class="line"><span class="cl">        <span class="n">startVal</span><span class="p">=</span><span class="n">currentVal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//可以进行更复杂的操作，只要将最终结果放到desireVal中</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//基于startVal和value计算desiredVal</span>
</span></span><span class="line"><span class="cl">        <span class="n">desireVal</span><span class="p">=</span><span class="n">Math</span><span class="p">.</span><span class="n">Max</span><span class="p">(</span><span class="n">startVal</span><span class="p">,</span><span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//注意：线程在这里可能被&#34;抢占”，所以以下代码不是原子性的</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//if(target==startValue)target==desireVal</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//而应使用以下原子性的CompareExchange方法，它返回target在被方法修改前的值</span>
</span></span><span class="line"><span class="cl">        <span class="n">currentVale</span><span class="p">=</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span><span class="n">desireVal</span><span class="p">,</span><span class="n">startVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//这个原子语句等于</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//currentValue=target;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//if(target==startValue)target==desireVal</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">startVal</span><span class="p">!=</span><span class="n">currentVal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//在线程尝试设置它之前返回最大值</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">desireVal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>进入方法currentValue初始化为target值</p>
</li>
<li>
<p>在循环内部，startVal初始化为target值，可用startVal执行希望的任何操作，这个操作可以非常复杂，但最终需要将结果放到desiredValue中。在循环体中其他线程可能更改target值，如果其他线程更改，在执行原子语句的时候，currentValue=target，会再一次执行循环startvalue=currentvalue。</p>
</li>
<li>
<p>第一个线程进入循环，如果这个时候有第二个线程执行进入循环，并执行完，target就会改变，第一个线程执行到Interlocked.ComareExchange，while时，会发现为true，重新执行一边，这就是乐观锁。</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">delegate</span> <span class="n">Int32</span> <span class="n">Morpher</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">,</span><span class="n">TArgument</span><span class="p">&gt;(</span><span class="n">Int32</span> <span class="n">startValue</span><span class="p">,</span><span class="n">TArgument</span> <span class="n">argument</span><span class="p">,</span><span class="k">out</span> <span class="n">TResult</span> <span class="n">morphResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">static</span> <span class="n">TResult</span> <span class="n">Morph</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">,</span><span class="n">TArgument</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">,</span><span class="n">TArgument</span> <span class="n">argument</span><span class="p">,</span><span class="n">Morpher</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">,</span><span class="n">TArgument</span><span class="p">&gt;</span> <span class="n">morpher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">TResult</span> <span class="n">morphResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Int32</span> <span class="n">currentVal</span><span class="p">=</span><span class="n">target</span><span class="p">,</span><span class="n">startVal</span><span class="p">,</span><span class="n">desiredVal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">do</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">startVal</span><span class="p">=</span><span class="n">currentVal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">desiredVal</span><span class="p">=</span><span class="n">morpher</span><span class="p">(</span><span class="n">startVal</span><span class="p">,</span><span class="n">argument</span><span class="p">,</span><span class="k">out</span> <span class="n">morphResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">currentVal</span><span class="p">=</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">CmpareEcvhange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span><span class="n">desiredVal</span><span class="p">,</span><span class="n">startVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span><span class="p">(</span><span class="n">startVal</span><span class="p">!=</span><span class="n">currentVal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">morphResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>回调函数有一定性能损失，最好使用内联；</p>
<h3 id="内核模式构造" class="heading-element"><span>内核模式构造</span>
  <a href="#%e5%86%85%e6%a0%b8%e6%a8%a1%e5%bc%8f%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>内核模式构造比用户模式构造慢的多，有两个原因：1、需要Windows操作系统配合，2、内核对象上调用每个方法都会使线程从托管代码转换成本机用户模式代码，再转换成本机内核模式代码。</p>
<p>优点:</p>
<ul>
<li>资源竞争的时候阻塞掉新城，不会浪费CPU资源。</li>
<li>实现本机(native)和托管(managed)线程之间的同步。</li>
<li>可同步在同一台机器中不同进程的线程</li>
<li>可应用安全性设置，防止未授权的账户访问</li>
<li>线程阻塞，直到所有内核模式可用，或集合中内核模式可用</li>
<li>阻塞的线程可以被时间值，在规定时间内获取不到资源就解除阻塞执行其他操作。</li>
</ul>
<p>事件和信号量（Semaphores）是基元内核模式同步构造，其他都是在这两个构造上派生的</p>
<p>System.Threading.WaitHandle抽象基类，唯一的作用就是包装一个Windows内核对象句柄</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">WaitHandle
</span></span><span class="line"><span class="cl">	EventWaitEvent
</span></span><span class="line"><span class="cl">		AutoResetEvent
</span></span><span class="line"><span class="cl">		ManualResetEvent
</span></span><span class="line"><span class="cl">    Semaphore
</span></span><span class="line"><span class="cl">    Mutex</span></span></code></pre></td></tr></table>
</div>
</div><p>WaitHandle内部有一个SafeWaitHandle字段，容纳一个Win32内核对象句柄。内核模式调用每个方法都代码一个完整的内存栅栏。</p>
<p><img loading="lazy" src="/dotnet/1582869283171.png" alt="1582869283171" srcset="/dotnet/1582869283171.png?size=small, /dotnet/1582869283171.png?size=medium 1.5x, /dotnet/1582869283171.png?size=large 2x" data-title="1582869283171" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/dotnet/1582869291300.png" alt="1582869291300" srcset="/dotnet/1582869291300.png?size=small, /dotnet/1582869291300.png?size=medium 1.5x, /dotnet/1582869291300.png?size=large 2x" data-title="1582869291300" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ul>
<li>WaitOne：让调用线程等待底层内核对象接收信号，内部调用Win32 WaitForSignleObjectEx函数，如果对象收到信号返回true，超时返回false。内部元素不能超过64</li>
<li>WaitAll:让调用线程等待WaitHandle[]中指定所有内核对象收到信息，如果所有对象收到信号，返回true，超时返回false，内部调用Win32 WaitForMultipleObjectsEx函数，bWaitAll参数传递TRUE，内部元素不能超过64</li>
<li>WaitAny:让调用线程等待WaitHandle[]指定任何内核对象收到信号。返回Int32内核对象对应的数组索引，如果一直没有收到，返回WaitHandle.WaitTimeout,内部调用Win32 WaitForMultipleObjectsEx</li>
<li>Dispose:关闭底层内核对象句柄，内部调用Win32 CloseHandle，只有在确定没有别的线程使用内核线程对象才能显式调用</li>
</ul>
<p>AutoResetEvent、ManualResetEvent、Semaphore和Mutex类都派生WaitHandle</p>
<ul>
<li>内部调用Win32 CreateEvent、CreateSemaphore或CreateMutex函数，函数句柄保存在私有的SafeWaitHandle字段中。</li>
<li>EventWaitHandle、Semaphore和Mutex都提供静态OpenExisting方法，内部调用win32 OpenEvent、OpenSemaphire或OpenMutex函数，</li>
</ul>
<p>内核模式常用的方法是创建任何时刻只允许它运行的应用程序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">Program</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Boolean</span> <span class="n">createNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//尝试创建一个具有指定名称的内核对象</span>
</span></span><span class="line"><span class="cl">		<span class="n">using</span><span class="p">(</span><span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="s">&#34;SomeUniqueStringIdentifyingMyApp&#34;</span><span class="p">,</span><span class="k">out</span> <span class="n">createdNew</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">createdNew</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//这个线程创建了内核对象，所以肯定没有这个应用程序的其他实例正在运行</span>
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="err">有其他实例在运行</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>将Semaphore替换成EventWaitHandle或Mutex一样的。两个线程同时创建Semaphore,windows内核确保只有一个能成功创建</p>
<h4 id="event" class="heading-element"><span>Event</span>
  <a href="#event" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Event内部维护内核Boolean变量，false：事件在等待线程阻塞，true解除阻塞。</p>
<ul>
<li>false，阻塞</li>
<li>true,不阻塞。</li>
</ul>
<p>有两种事件，自动重置事件（AutoResetEvent）和手动重置事件(ManualResetEvent)。</p>
<p>AutoResetEvent:true的时候，唤起一个阻塞线程，然后自动为false，其余线程阻塞。</p>
<p>ManualResetEvent:true的时候，解除正在等待的所有线程阻塞，内核不会重置为false，必须手动进行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="k">class</span> <span class="nc">EventWaitHandle</span><span class="p">:</span><span class="n">WaitHandle</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Boolean</span> <span class="n">Set</span><span class="p">();</span><span class="c1">//将内核Boolean设置为true，总是返回true</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Boolean</span> <span class="n">Reset</span><span class="p">();</span><span class="c1">//将内核Boolean设为false,总是返回true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">AutoResetEvent</span><span class="p">:</span><span class="n">EventWaitHandle</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">initialState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">ManualReserEvent</span><span class="p">:</span><span class="n">EventWaitHandle</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">ManualReserEvent</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">initialState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>事件锁</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">SimpleWaitLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AutoResetEvent</span> <span class="n">m_available</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">SimpleWaitLock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// Initially free</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Block in kernel until resource available</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Let another thread access the resource</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_available</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">SimpleWaitLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AutoResetEvent</span> <span class="n">m_available</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">SimpleWaitLock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// 最开始可以自由使用</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 在内核中阻塞，直到资源可用，直到一个内核对象变为true，获取对象后自动变成false</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 让另一个线程访问资源,置true</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_available</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>性能比较</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="c1">//调用go</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">LockComparison</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Go</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Int32</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">const</span> <span class="n">Int32</span> <span class="n">iterations</span> <span class="p">=</span> <span class="m">10000000</span><span class="p">;</span>  <span class="c1">// 10 million</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// How long does it take to increment x 10 million times?</span>
</span></span><span class="line"><span class="cl">      <span class="n">Stopwatch</span> <span class="n">sw</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">x</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Incrementing x: {0:N0}&#34;</span><span class="p">,</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// How long does it take to increment x 10 million times </span>
</span></span><span class="line"><span class="cl">      <span class="c1">// adding the overhead of calling a method that does nothing?</span>
</span></span><span class="line"><span class="cl">      <span class="n">sw</span><span class="p">.</span><span class="n">Restart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">M</span><span class="p">();</span> <span class="n">x</span><span class="p">++;</span> <span class="n">M</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Incrementing x in M: {0:N0}&#34;</span><span class="p">,</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// How long does it take to increment x 10 million times </span>
</span></span><span class="line"><span class="cl">      <span class="c1">// adding the overhead of calling an uncontended SimpleSpinLock?</span>
</span></span><span class="line"><span class="cl">      <span class="n">SimpleSpinLock</span> <span class="n">ssl</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleSpinLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">sw</span><span class="p">.</span><span class="n">Restart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ssl</span><span class="p">.</span><span class="n">Enter</span><span class="p">();</span> <span class="n">x</span><span class="p">++;</span> <span class="n">ssl</span><span class="p">.</span><span class="n">Leave</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Incrementing x in SimpleSpinLock: {0:N0}&#34;</span><span class="p">,</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// How long does it take to increment x 10 million times </span>
</span></span><span class="line"><span class="cl">      <span class="c1">// adding the overhead of calling an uncontended SpinLock?</span>
</span></span><span class="line"><span class="cl">      <span class="n">SpinLock</span> <span class="n">sl</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SpinLock</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sw</span><span class="p">.</span><span class="n">Restart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Boolean</span> <span class="n">taken</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">sl</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="k">ref</span> <span class="n">taken</span><span class="p">);</span> <span class="n">x</span><span class="p">++;</span> <span class="n">sl</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Incrementing x in SpinLock: {0:N0}&#34;</span><span class="p">,</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// How long does it take to increment x 10 million times </span>
</span></span><span class="line"><span class="cl">      <span class="c1">// adding the overhead of calling an uncontended SimpleWaitLock?</span>
</span></span><span class="line"><span class="cl">      <span class="k">using</span> <span class="p">(</span><span class="n">SimpleWaitLock</span> <span class="n">swl</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SimpleWaitLock</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">sw</span><span class="p">.</span><span class="n">Restart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">iterations</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">swl</span><span class="p">.</span><span class="n">Enter</span><span class="p">();</span> <span class="n">x</span><span class="p">++;</span> <span class="n">swl</span><span class="p">.</span><span class="n">Leave</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Incrementing x in SimpleWaitLock: {0:N0}&#34;</span><span class="p">,</span> <span class="n">sw</span><span class="p">.</span><span class="n">ElapsedMilliseconds</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">   [MethodImpl(MethodImplOptions.NoInlining)]</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">M</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">internal</span> <span class="k">struct</span> <span class="nc">SimpleSpinLock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_ResourceInUse</span><span class="p">;</span> <span class="c1">// 0=false (default), 1=true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Always set resource to in-use</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// When this thread changes it from not in-use, return</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Exchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_ResourceInUse</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Black magic goes here...</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Set resource to not in-use</span>
</span></span><span class="line"><span class="cl">         <span class="n">Volatile</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_ResourceInUse</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">SimpleWaitLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AutoResetEvent</span> <span class="n">m_available</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">SimpleWaitLock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// Initially free</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Block in kernel until resource available</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// Let another thread access the resource</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_available</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_available</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//结果</span>
</span></span><span class="line"><span class="cl"><span class="n">Incrementing</span> <span class="n">x</span><span class="p">:</span> <span class="m">24</span>
</span></span><span class="line"><span class="cl"><span class="n">Incrementing</span> <span class="n">x</span> <span class="k">in</span> <span class="n">M</span><span class="p">:</span> <span class="m">57</span>
</span></span><span class="line"><span class="cl"><span class="n">Incrementing</span> <span class="n">x</span> <span class="k">in</span> <span class="n">SimpleSpinLock</span><span class="p">:</span> <span class="m">166</span>
</span></span><span class="line"><span class="cl"><span class="n">Incrementing</span> <span class="n">x</span> <span class="k">in</span> <span class="n">SpinLock</span><span class="p">:</span> <span class="m">182</span>
</span></span><span class="line"><span class="cl"><span class="n">Incrementing</span> <span class="n">x</span> <span class="k">in</span> <span class="n">SimpleWaitLock</span><span class="p">:</span> <span class="m">22</span><span class="p">,</span><span class="m">526</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看出仅仅加了什么都不做的函数性能都与影响，而内核事件锁的性能比自旋锁慢了近1000倍</p>
<ul>
<li>能避免线程同步就避免线程同步</li>
<li>如果一定要进行线程同步请使用用户模式构造。内核模式尽量避免。</li>
</ul>
<h4 id="semaphore构造" class="heading-element"><span>Semaphore构造</span>
  <a href="#semaphore%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Semaphore在内部维护内核的Int32变量，Int32不同值代表的意思：</p>
<ul>
<li>
<p>0，在等待信号量的线程会阻塞，阻塞</p>
</li>
<li>
<p>大于0，在等待信号量的线程解除阻塞。不阻塞，每有一个线程解除阻塞，int32值自动减1，</p>
</li>
<li>
<p>Int32值还关联了一个最大值，计数不允许超过最大值</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Semaphore</span><span class="p">:</span><span class="n">WaitHandle</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Semaphore</span><span class="p">(</span><span class="n">Int32</span> <span class="n">initialCOunt</span><span class="p">,</span><span class="n">Int32</span> <span class="n">maximumCOunt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Int32</span> <span class="n">Release</span><span class="p">();</span><span class="c1">//调用Release(1)，返回上一个计数</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Int32</span> <span class="n">Release</span><span class="p">(</span><span class="n">Int32</span> <span class="n">releaseCount</span><span class="p">);</span><span class="c1">//返回上一个计数</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Semaphore与AutoResetEvent,ManualResetEvent的异同</p>
<p>AutoResetEvent:不阻塞时，只有一个线程被解除阻塞</p>
<p>ManualResetEvent:不阻塞时，所有线程被解除阻塞</p>
<p>Semaphore:不阻塞时，可以使得releaseCount个线程被解除阻塞。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">SimpleWaitLovk</span><span class="p">:</span><span class="n">IDisposable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">Semaphore</span> <span class="n">m_available</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">SimpleWaitLock</span><span class="p">(</span><span class="n">Int32</span> <span class="n">maxConcurrent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_available</span><span class="p">=</span><span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="n">maxConcurrent</span><span class="p">,</span><span class="n">maxConcurrent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//在内核中阻塞直到资源可用</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_available</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_available</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">(){</span><span class="n">m_available</span><span class="p">.</span><span class="n">Close</span><span class="p">();}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mutex" class="heading-element"><span>Mutex</span>
  <a href="#mutex" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Mutex和AutoaResetEvent的工作方式差不多，但是有很多额外的逻辑</p>
<ul>
<li>其会查询调用线程Int32 ID,在线程ReleaseMutex时，会对比释放线程和调用线程是否一致。不一致不会更改，而且释放线程会抛出System.ApplicaionException.</li>
<li>如果拥有Mutex的线程异常终止，会抛出System.Threading.AbandoneMutexExeception异常，在等待Mutex的线程会被唤醒。</li>
<li>Mutex维护了一个递归计数，指出拥该Mutex的线程拥有它多少次。在调用ReleaseMutex会导致递减。</li>
</ul>
<p>最后这个递归计数的功能是在递归锁中用到，<strong>递归锁的使用场景是在一个获取锁的方法中调用另一个也需要锁的方法。这时就需要递归锁</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span><span class="n">IDisposable</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="k">readonly</span> <span class="n">Mutex</span> <span class="n">m_lock</span><span class="p">=</span><span class="k">new</span> <span class="n">Mutex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Method1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_lock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//随便做什么事情。。。</span>
</span></span><span class="line"><span class="cl">		<span class="n">Method2</span><span class="p">();</span><span class="c1">//Method2递归地获取锁</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_lock</span><span class="p">.</span><span class="n">ReleaseMutex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Method2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_lock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//随便做什么</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_lock</span><span class="p">.</span><span class="n">ReleaseMutex</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_lock</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用AutoResetEvent也可用构造递归锁，从而摆脱Mutex的复杂操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">RecursiveAutoResetEvent</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="n">AutoResetEvent</span> <span class="n">m_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_recursionCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 获取调用线程的唯一 Int32 ID</span>
</span></span><span class="line"><span class="cl">      <span class="n">Int32</span> <span class="n">currentThreadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果调用线程拥有锁，就递增递归计数</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">m_owningThreadId</span> <span class="p">==</span> <span class="n">currentThreadId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_recursionCount</span><span class="p">++;</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 调用线程不拥有锁，等待它</span>
</span></span><span class="line"><span class="cl">      <span class="n">m_lock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 调用线程现在拥有锁，初始化拥有线程的ID和计数器</span>
</span></span><span class="line"><span class="cl">      <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="n">currentThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">m_recursionCount</span><span class="p">--;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果调用的线程不拥有锁就出错</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">m_owningThreadId</span> <span class="p">!=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidOperationException</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 从递归计数中减1</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(--</span><span class="n">m_recursionCount</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 如果递归计数为0，表明没有线程拥有锁</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_lock</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>   <span class="c1">// 唤醒一个正在等待的线程(如果有的话)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_lock</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="混合线程同步构造" class="heading-element"><span>混合线程同步构造</span>
  <a href="#%e6%b7%b7%e5%90%88%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="一个简单混合锁" class="heading-element"><span>一个简单混合锁</span>
  <a href="#%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e6%b7%b7%e5%90%88%e9%94%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">SimpleHybridLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// The Int32 is used by the primitive user-mode constructs (Interlocked mehtods)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_waiters</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// The AutoResetEvent is the primitive kernel-mode construct</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">readonly</span> <span class="n">AutoResetEvent</span> <span class="n">m_waiterLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 多个线程获得锁</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_waiters</span><span class="p">)</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span> <span class="c1">//无竞争直接返回</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">//多个线程获得锁发生竞争，阻塞线程，</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>  <span class="c1">// 性能影响较大</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// WaitOnef返回一个线程获得锁。</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 无竞争的时候释放原子锁</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_waiters</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span> <span class="c1">// 没有其他线程等待，直接返回</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 唤醒一个阻塞的线程</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>  <span class="c1">// 这里产生较大影响</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="自旋线程所有权和递归" class="heading-element"><span>自旋、线程所有权和递归</span>
  <a href="#%e8%87%aa%e6%97%8b%e7%ba%bf%e7%a8%8b%e6%89%80%e6%9c%89%e6%9d%83%e5%92%8c%e9%80%92%e5%bd%92" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>使用内核模式非常影响性能，所以就有了自旋锁，即使线程什么也不干，自旋一定时间也不使用内核模式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">AnotherHybridLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// The Int32 is used by the primitive user-mode constructs (Interlocked methods)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_waiters</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// The AutoResetEvent is the primitive kernel-mode construct</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">AutoResetEvent</span> <span class="n">m_waiterLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AutoResetEvent</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// This field controls spinning in an effort to improve performance</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_spincount</span> <span class="p">=</span> <span class="m">4000</span><span class="p">;</span>   <span class="c1">// Arbitrarily chosen count</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// 字段指出哪个线程拥有锁，以及拥有了多少次，以支持递归锁</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">m_recursion</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// If the calling thread already owns this lock, increment the recursion count and return</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">threadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">threadId</span> <span class="p">==</span> <span class="n">m_owningThreadId</span><span class="p">)</span> <span class="p">{</span> <span class="n">m_recursion</span><span class="p">++;</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// SpinWait值类型</span>
</span></span><span class="line"><span class="cl">         <span class="n">SpinWait</span> <span class="n">spinwait</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SpinWait</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">spinCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">spinCount</span> <span class="p">&lt;</span> <span class="n">m_spincount</span><span class="p">;</span> <span class="n">spinCount</span><span class="p">++)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If the lock was free, this thread got it; set some state and return</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_waiters</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">GotLock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 发生线程竞争后线程等待</span>
</span></span><span class="line"><span class="cl">            <span class="n">spinwait</span><span class="p">.</span><span class="n">SpinOnce</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 自旋结束，锁还没获得，再试一次</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_waiters</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果仍在竞争进入内核模式</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span> <span class="c1">// Wait for the lock; performance hit</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// When this thread wakes, it owns the lock; set some state and return</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">GotLock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// When a thread gets the lock, we record its ID and </span>
</span></span><span class="line"><span class="cl">         <span class="c1">// indicate that the thread owns the lock once</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="n">threadId</span><span class="p">;</span> <span class="n">m_recursion</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// 如果调用线程不拥有锁，抛出异常</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">threadId</span> <span class="p">=</span> <span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">threadId</span> <span class="p">!=</span> <span class="n">m_owningThreadId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">SynchronizationLockException</span><span class="p">(</span><span class="s">&#34;Lock not owned by calling thread&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 递归锁减去次数</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(--</span><span class="n">m_recursion</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="n">m_owningThreadId</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>   <span class="c1">// No thread owns the lock now</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 没有其他线程在等待</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_waiters</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// 有其他线程等待，唤起一个</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>	<span class="c1">// Bad performance hit here</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_waiterLock</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fcl中的混合构造" class="heading-element"><span>FCL中的混合构造</span>
  <a href="#fcl%e4%b8%ad%e7%9a%84%e6%b7%b7%e5%90%88%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>FCL也提供了很多的混合构造锁，一起研究以下。</p>
<h4 id="manualreseteventslim和semaphoreslim" class="heading-element"><span>ManualResetEventSlim和SemaphoreSlim</span>
  <a href="#manualreseteventslim%e5%92%8csemaphoreslim" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>ManualResetEventSlim和SemaphoreSlim类，这两个构造的工作方式和内核模式构造都是瓦全一样的。都在用户模式自旋，在第一次竞争使才创建内核模式，wait方法允许传递一个超时值和一个CancellationToken。</p>
<h4 id="monitor和同步块" class="heading-element"><span>Monitor和同步块</span>
  <a href="#monitor%e5%92%8c%e5%90%8c%e6%ad%a5%e5%9d%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>最常用的混合同步构造就是Monitor，它提供自旋、线程所有权和递归的互斥锁。</p>
<p>堆中每个对象都可以关联一个<strong>同步块</strong>的数据结构，该数据结构的字段：内核对象字段，拥有线程的ID字段，递归计数字段，等待线程计数字段。</p>
<p>Monitor是静态类，拥有的方法可以接受任何堆对象的引用，然后操作对象的同步块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">static</span> <span class="k">class</span> <span class="nc">Monitor</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Exit</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//尝试进入锁时超时值</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">TryEnter</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">,</span><span class="n">Int32</span> <span class="n">millisecondsTimeOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">,</span><span class="k">ref</span> <span class="n">Boolean</span> <span class="n">lockTaken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">TryEnter</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">,</span><span class="n">Int32</span> <span class="n">millisecondsTimeout</span><span class="p">,</span><span class="k">ref</span> <span class="n">Boolean</span> <span class="n">lockTaken</span><span class="p">)</span><span class="err">；</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如果每个对象都关联一个同步块数据就非常浪费内存，所以CLR进行了改进:CLR初始化时在堆中分配一个同步块数组。在堆中创建对象的实例，都有两个额外的开销：类型对象指针(指向类型对象的内存地址)，同步块索引：同步块数组中的整数索引。</p>
<p>对象实例在构造时，同步块索引初始化为-1，调用Monitor.Enter时，CLR找到一个空白同步块，并设置对象实例的同步块，在调用Exit时，检查是否有其他线程等待对象实例的同步块，如果没有同步块就自由了，对象实例同步块被设为-1.</p>
<p><img loading="lazy" src="/dotnet/1582964468619.png" alt="1582964468619" srcset="/dotnet/1582964468619.png?size=small, /dotnet/1582964468619.png?size=medium 1.5x, /dotnet/1582964468619.png?size=large 2x" data-title="1582964468619" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>三个对象实例通过类型对象指针，指向类型T，说明他们都是同一个类型,可以看出每个对象的同步块索引都隐式为公共的。这会造成问题。先看一下正常调用的情况。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Transaction</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">DateTime</span> <span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">PerformTransaction</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//以下代码拥有对数据的独占访问权</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_timeOfLastTrans</span><span class="p">=</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">DateTime</span> <span class="n">LastTransaction</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">get</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//以下线程拥有对数据的独占访问</span>
</span></span><span class="line"><span class="cl">			<span class="n">DateTime</span> <span class="n">temp</span><span class="p">=</span><span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>有问题调用的情况</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">public</span> <span class="k">static</span> <span class="n">void</span> <span class="n">SomeMethod</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">var</span> <span class="n">t</span><span class="o">=</span><span class="n">new</span> <span class="n">Transaction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">Monitor</span><span class="o">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="o">//</span><span class="err">获取锁</span>
</span></span><span class="line"><span class="cl">	<span class="n">ThreadPool</span><span class="o">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="n">o</span><span class="o">=&gt;</span><span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">LastTransaction</span><span class="p">))</span><span class="err">；</span><span class="o">//</span><span class="err">如果在</span><span class="n">LastTransaction内部也是用Monitor</span><span class="o">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="err">，线程会阻塞，因为在外部以及调用了</span><span class="n">Monitor</span><span class="o">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="err">，获取了</span><span class="n">t的同步锁</span><span class="err">。</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>所以在使用Monitro的时候最好构造一个字段，也称私有锁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">internal</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Transaction</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">readonlu</span> <span class="n">Object</span> <span class="n">m_lock</span><span class="p">=</span><span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="n">DateTIe</span> <span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="k">void</span> <span class="n">PerformTransaction</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_timeOfLastTrans</span><span class="p">=</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">DateTime</span> <span class="n">LastTransaction</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">get</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">DateTime</span> <span class="n">temp</span><span class="p">=</span><span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">m_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">temp</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Monitor被设置为静态的还有一些其他的问题。所以尽量不要使用Monitor和lock</p>
<h4 id="readwritelockslim类" class="heading-element"><span>ReadWriteLockSlim类</span>
  <a href="#readwritelockslim%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>读写锁：</p>
<ul>
<li>一个线程写入，所有访问线程阻塞</li>
<li>读取时，所有写入线程阻塞</li>
<li>写入线程结束，要么解除一个写入线程，要么解除所有读取线程阻塞。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="kd">private</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Transactions</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">readonly</span> <span class="n">ReaderWriterLockSlim</span> <span class="n">m_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReaderWriterLockSlim</span><span class="p">(</span><span class="n">LockRecursionPolicy</span><span class="p">.</span><span class="n">NoRecursion</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">DateTime</span> <span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">PerformTransaction</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_lock</span><span class="p">.</span><span class="n">EnterWriteLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// This code has exclusive access to the data...</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_timeOfLastTrans</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_lock</span><span class="p">.</span><span class="n">ExitWriteLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">DateTime</span> <span class="n">LastTransaction</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">get</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_lock</span><span class="p">.</span><span class="n">EnterReadLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// This code has shared access to the data...</span>
</span></span><span class="line"><span class="cl">            <span class="n">DateTime</span> <span class="n">temp</span> <span class="p">=</span> <span class="n">m_timeOfLastTrans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_lock</span><span class="p">.</span><span class="n">ExitReadLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_lock</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ReadWriteLockSlim构造器允许传递一个LockRecurionsPolicy标志，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">LockRecursionPolicy</span> <span class="p">{</span><span class="n">NoRecursion</span><span class="p">,</span><span class="n">SupportsRecursion</span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>SupportsRecursion标志，允许传递线程所有权和递归。建议使用NoRecursion，因为SupportsRecursion代价很大，在内部使用了一个互斥的自旋锁来实现线程所有权和递归。</p>
<p>ReadWriteLockSlim运行权限升级，读取锁升级为写入锁。</p>
<p>存在的问题</p>
<ul>
<li>即使不存在线程竞争，速度也非常慢。</li>
<li>线程所有权和递归行为是加强的取消不了。</li>
</ul>
<h4 id="onemanylock类" class="heading-element"><span>OneManyLock类</span>
  <a href="#onemanylock%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>JeffreyRicher提供的读写锁，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// Implements a ResourceLock by way of a high-speed reader/writer lock.</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">OneManyLock</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Lock</span> <span class="n">State</span> <span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">struct</span> <span class="nc">BitField</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_mask</span><span class="p">,</span> <span class="n">m_1</span><span class="p">,</span> <span class="n">m_startBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">BitField</span><span class="p">(</span><span class="n">Int32</span> <span class="n">startBit</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">numBits</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_startBit</span> <span class="p">=</span> <span class="n">startBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_mask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">numBits</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">startBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_1</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">startBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">+=</span> <span class="n">m_1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">-=</span> <span class="n">m_1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">-=</span> <span class="n">m_1</span> <span class="p">*</span> <span class="n">amount</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">Int32</span> <span class="n">Get</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">value</span> <span class="p">&amp;</span> <span class="n">m_mask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">m_startBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">Int32</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">fieldValue</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">value</span> <span class="p">&amp;</span> <span class="p">~</span><span class="n">m_mask</span><span class="p">)</span> <span class="p">|</span> <span class="p">(</span><span class="n">fieldValue</span> <span class="p">&lt;&lt;</span> <span class="n">m_startBit</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_state</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_readersReading</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_readersWaiting</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">12</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_writersWaiting</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">21</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">OneManyLockStates</span> <span class="n">State</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">OneManyLockStates</span><span class="p">)</span><span class="n">s_state</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">State</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">OneManyLockStates</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ls</span> <span class="p">=</span> <span class="n">s_state</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span><span class="n">newState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">enum</span> <span class="n">OneManyLockStates</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Free</span> <span class="p">=</span> <span class="m">0x00000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByWriter</span> <span class="p">=</span> <span class="m">0x00000001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByReaders</span> <span class="p">=</span> <span class="m">0x00000002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByReadersAndWriterPending</span> <span class="p">=</span> <span class="m">0x00000003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">ReservedForWriter</span> <span class="p">=</span> <span class="m">0x00000004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsStateStartBit</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersReadingStartBit</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersWaitingStartBit</span> <span class="p">=</span> <span class="m">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsWritersWaitingStartBit</span> <span class="p">=</span> <span class="m">21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Mask = unchecked((Int32) ((1 &lt;&lt; numBits) - 1) &lt;&lt; startBit);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsStateMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsStateStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersReadingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersWaitingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsWritersWaitingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsAnyWaitingMask</span> <span class="p">=</span> <span class="n">c_lsReadersWaitingMask</span> <span class="p">|</span> <span class="n">c_lsWritersWaitingMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// FirstBit = unchecked((Int32) 1 &lt;&lt; startBit);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1ReaderReading</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1ReaderWaiting</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1WriterWaiting</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">OneManyLockStates</span> <span class="n">State</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">OneManyLockStates</span><span class="p">)(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsStateMask</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">OneManyLockStates</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ls</span> <span class="p">=</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="p">~</span><span class="n">c_lsStateMask</span><span class="p">)</span> <span class="p">|</span> <span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="n">newState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumReadersReading</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsReadersReadingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1ReaderReading</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsReadersWaitingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1ReaderWaiting</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsWritersWaitingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1WriterWaiting</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">AnyWaiters</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsAnyWaitingMask</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">DebugState</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;State={0}, RR={1}, RW={2}, WW={3}&#34;</span><span class="p">,</span> <span class="n">State</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">NumReadersReading</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span> <span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">ls</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// Returns a string representing the state of the object.</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;returns&gt;The string representing the state of the object.&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kd">override</span> <span class="n">String</span> <span class="n">ToString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">DebugState</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">State</span> <span class="n">Fields</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_LockState</span> <span class="p">=</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span><span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Readers wait on this if a writer owns the lock</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Semaphore</span> <span class="n">m_ReadersLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Writers wait on this if a reader owns the lock</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Semaphore</span> <span class="n">m_WritersLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Construction</span> <span class="n">and</span> <span class="n">Dispose</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Constructs a OneManyLock object.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">OneManyLock</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">m_WritersLock</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">m_ReadersLock</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Writer</span> <span class="n">members</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Boolean</span> <span class="n">m_exclusive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Acquires the lock.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Enter</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">WaitToWrite</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">))</span> <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">WaitToRead</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">))</span> <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_exclusive</span> <span class="p">=</span> <span class="n">exclusive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">WaitToWrite</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Boolean</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">:</span>  <span class="c1">// If Free -&gt; OBW, return</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">:</span> <span class="c1">// If RFW -&gt; OBW, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">:</span>  <span class="c1">// If OBW -&gt; WW++, wait &amp; loop around</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">:</span> <span class="c1">// If OBR or OBRAWP -&gt; OBRAWP, WW++, wait, loop around</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Invalid Lock state&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Releases the lock.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="k">void</span> <span class="n">Leave</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">m_exclusive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">NumReadersReading</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-condition:  Lock&#39;s state must be OBW (not Free/OBR/OBRAWP/RFW)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Post-condition: Lock&#39;s state must become Free or RFW (the lock is never passed)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Phase 1: Release the lock</span>
</span></span><span class="line"><span class="cl">            <span class="n">wakeup</span> <span class="p">=</span> <span class="n">DoneWriting</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-condition:  Lock&#39;s state must be OBR/OBRAWP (not Free/OBW/RFW)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Post-condition: Lock&#39;s state must become unchanged, Free or RFW (the lock is never passed)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Phase 1: Release the lock</span>
</span></span><span class="line"><span class="cl">            <span class="n">wakeup</span> <span class="p">=</span> <span class="n">DoneReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Phase 2: Possibly wake waiters</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Returns -1 to wake a writer, +# to wake # readers, or 0 to wake no one</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">DoneWriting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// We do this test first because it is commonly true &amp; </span>
</span></span><span class="line"><span class="cl">            <span class="c1">// we avoid the other tests improving performance</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">AnyWaiters</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">wakeup</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// RW=0, RR=0 (incremented as readers enter)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Reader</span> <span class="n">members</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">WaitToRead</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Boolean</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">:</span>  <span class="c1">// If Free-&gt;OBR, RR=1, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">:</span> <span class="c1">// If OBR -&gt; RR++, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">:</span>  <span class="c1">// If OBW/OBRAWP/RFW -&gt; RW++, wait, loop around</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Invalid Lock state&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Returns -1 to wake a writer, +# to wake # readers, or 0 to wake no one</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">DoneReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  <span class="c1">// RR--</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">NumReadersReading</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// RR&gt;0, no state change &amp; no threads to wake</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(!</span><span class="n">AnyWaiters</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>   <span class="c1">// Wake 1 writer</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>该锁维护了哪些内容：锁状态，正在读取reader线程数量(RR)，等待reader线程数量(RW，这些线程在AutoResetEvent阻塞)，正在等待写入write锁的数量(WW，在Semaphore上阻塞)</p>
<p>作责还提供了一个OneManyResourceLock可以死锁检测，锁的所有权和递归行为，锁的运行时行为，线程等待获取一个锁的最长时间和一个锁被占有的最短和最长时间。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">   <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// Implements a ResourceLock by way of a high-speed reader/writer lock.</span>
</span></span><span class="line"><span class="cl">   <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">OneManyResourceLock</span> <span class="p">:</span> <span class="n">ResourceLock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Lock</span> <span class="n">State</span> <span class="n">Management</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="k">struct</span> <span class="nc">BitField</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_mask</span><span class="p">,</span> <span class="n">m_1</span><span class="p">,</span> <span class="n">m_startBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">BitField</span><span class="p">(</span><span class="n">Int32</span> <span class="n">startBit</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">numBits</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_startBit</span> <span class="p">=</span> <span class="n">startBit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_mask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">numBits</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">startBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">m_1</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">startBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">+=</span> <span class="n">m_1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">-=</span> <span class="n">m_1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="k">void</span> <span class="n">Decrement</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="k">value</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="k">value</span> <span class="p">-=</span> <span class="n">m_1</span> <span class="p">*</span> <span class="n">amount</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">Int32</span> <span class="n">Get</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">value</span> <span class="p">&amp;</span> <span class="n">m_mask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">m_startBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="n">Int32</span> <span class="n">Set</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">fieldValue</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">value</span> <span class="p">&amp;</span> <span class="p">~</span><span class="n">m_mask</span><span class="p">)</span> <span class="p">|</span> <span class="p">(</span><span class="n">fieldValue</span> <span class="p">&lt;&lt;</span> <span class="n">m_startBit</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_state</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_readersReading</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_readersWaiting</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">12</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">BitField</span> <span class="n">s_writersWaiting</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BitField</span><span class="p">(</span><span class="m">21</span><span class="p">,</span> <span class="m">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">OneManyLockStates</span> <span class="n">State</span><span class="p">(</span><span class="n">Int32</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">OneManyLockStates</span><span class="p">)</span><span class="n">s_state</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">State</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">OneManyLockStates</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ls</span> <span class="p">=</span> <span class="n">s_state</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">ls</span><span class="p">,</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span><span class="n">newState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">enum</span> <span class="n">OneManyLockStates</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Free</span> <span class="p">=</span> <span class="m">0x00000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByWriter</span> <span class="p">=</span> <span class="m">0x00000001</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByReaders</span> <span class="p">=</span> <span class="m">0x00000002</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">OwnedByReadersAndWriterPending</span> <span class="p">=</span> <span class="m">0x00000003</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="n">ReservedForWriter</span> <span class="p">=</span> <span class="m">0x00000004</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsStateStartBit</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersReadingStartBit</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersWaitingStartBit</span> <span class="p">=</span> <span class="m">12</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsWritersWaitingStartBit</span> <span class="p">=</span> <span class="m">21</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Mask = unchecked((Int32) ((1 &lt;&lt; numBits) - 1) &lt;&lt; startBit);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsStateMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsStateStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersReadingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsReadersWaitingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsWritersWaitingMask</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)((</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="m">9</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_lsAnyWaitingMask</span> <span class="p">=</span> <span class="n">c_lsReadersWaitingMask</span> <span class="p">|</span> <span class="n">c_lsWritersWaitingMask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// FirstBit = unchecked((Int32) 1 &lt;&lt; startBit);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1ReaderReading</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1ReaderWaiting</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">const</span> <span class="n">Int32</span> <span class="n">c_ls1WriterWaiting</span> <span class="p">=</span> <span class="k">unchecked</span><span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="m">1</span> <span class="p">&lt;&lt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">OneManyLockStates</span> <span class="n">State</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">OneManyLockStates</span><span class="p">)(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsStateMask</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">OneManyLockStates</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">ls</span> <span class="p">=</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="p">~</span><span class="n">c_lsStateMask</span><span class="p">)</span> <span class="p">|</span> <span class="p">((</span><span class="n">Int32</span><span class="p">)</span><span class="n">newState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumReadersReading</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsReadersReadingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsReadersReadingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1ReaderReading</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsReadersWaitingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsReadersWaitingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1ReaderWaiting</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsWritersWaitingMask</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="n">c_lsWritersWaitingStartBit</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="k">void</span> <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">ls</span><span class="p">,</span> <span class="n">Int32</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span> <span class="n">ls</span> <span class="p">+=</span> <span class="p">(</span><span class="n">c_ls1WriterWaiting</span> <span class="p">*</span> <span class="n">amount</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">AnyWaiters</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">ls</span> <span class="p">&amp;</span> <span class="n">c_lsAnyWaitingMask</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">DebugState</span><span class="p">(</span><span class="n">Int32</span> <span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;State={0}, RR={1}, RW={2}, WW={3}&#34;</span><span class="p">,</span> <span class="n">State</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">NumReadersReading</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">ls</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">ls</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// Returns a string representing the state of the object.</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;returns&gt;The string representing the state of the object.&lt;/returns&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kd">override</span> <span class="n">String</span> <span class="n">ToString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">DebugState</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">State</span> <span class="n">Fields</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Int32</span> <span class="n">m_LockState</span> <span class="p">=</span> <span class="p">(</span><span class="n">Int32</span><span class="p">)</span><span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Readers wait on this if a writer owns the lock</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Semaphore</span> <span class="n">m_ReadersLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Writers wait on this if a reader owns the lock</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="n">Semaphore</span> <span class="n">m_WritersLock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">Int32</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Construction</span> <span class="n">and</span> <span class="n">Dispose</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Constructs a OneManyLock object.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">public</span> <span class="n">OneManyResourceLock</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">ResourceLockOptions</span><span class="p">.</span><span class="n">None</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">///&lt;summary&gt;Releases all resources used by the lock.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">Dispose</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">disposing</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">m_WritersLock</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">m_ReadersLock</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">base</span><span class="p">.</span><span class="n">Dispose</span><span class="p">(</span><span class="n">disposing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Writer</span> <span class="n">members</span>
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Acquires the lock.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnEnter</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">exclusive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">WaitToWrite</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">))</span> <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">WaitToRead</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">))</span> <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">WaitToWrite</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Boolean</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">:</span>  <span class="c1">// If Free -&gt; OBW, return</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">:</span> <span class="c1">// If RFW -&gt; OBW, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">:</span>  <span class="c1">// If OBW -&gt; WW++, wait &amp; loop around</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">:</span> <span class="c1">// If OBR or OBRAWP -&gt; OBRAWP, WW++, wait, loop around</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">               <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Invalid Lock state&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cs">/// &lt;summary&gt;Releases the lock.&lt;/summary&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">protected</span> <span class="kd">override</span> <span class="k">void</span> <span class="n">OnLeave</span><span class="p">(</span><span class="n">Boolean</span> <span class="n">write</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">NumReadersReading</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="m">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-condition:  Lock&#39;s state must be OBW (not Free/OBR/OBRAWP/RFW)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Post-condition: Lock&#39;s state must become Free or RFW (the lock is never passed)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Phase 1: Release the lock</span>
</span></span><span class="line"><span class="cl">            <span class="n">wakeup</span> <span class="p">=</span> <span class="n">DoneWriting</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">((</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">)</span> <span class="p">||</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">m_LockState</span><span class="p">)</span> <span class="p">==</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pre-condition:  Lock&#39;s state must be OBR/OBRAWP (not Free/OBW/RFW)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Post-condition: Lock&#39;s state must become unchanged, Free or RFW (the lock is never passed)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Phase 1: Release the lock</span>
</span></span><span class="line"><span class="cl">            <span class="n">wakeup</span> <span class="p">=</span> <span class="n">DoneReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">m_LockState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Phase 2: Possibly wake waiters</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="n">m_WritersLock</span><span class="p">.</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="n">m_ReadersLock</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Returns -1 to wake a writer, +# to wake # readers, or 0 to wake no one</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">DoneWriting</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// We do this test first because it is commonly true &amp; </span>
</span></span><span class="line"><span class="cl">            <span class="c1">// we avoid the other tests improving performance</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="n">AnyWaiters</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="n">NumReadersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">wakeup</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="n">wakeup</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// RW=0, RR=0 (incremented as readers enter)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cp">#region</span> <span class="n">Reader</span> <span class="n">members</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="n">WaitToRead</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Boolean</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">wait</span> <span class="p">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">State</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">:</span>  <span class="c1">// If Free-&gt;OBR, RR=1, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReaders</span><span class="p">:</span> <span class="c1">// If OBR -&gt; RR++, return</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByWriter</span><span class="p">:</span>  <span class="c1">// If OBW/OBRAWP/RFW -&gt; RW++, wait, loop around</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">OwnedByReadersAndWriterPending</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">               <span class="k">case</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AddReadersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">wait</span> <span class="p">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Invalid Lock state&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Returns -1 to wake a writer, +# to wake # readers, or 0 to wake no one</span>
</span></span><span class="line"><span class="cl">      <span class="kd">private</span> <span class="kd">static</span> <span class="n">Int32</span> <span class="n">DoneReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">Int32</span> <span class="n">target</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">start</span><span class="p">,</span> <span class="n">current</span> <span class="p">=</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="n">Int32</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Int32</span> <span class="n">desired</span> <span class="p">=</span> <span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">AddReadersReading</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>  <span class="c1">// RR--</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">NumReadersReading</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// RR&gt;0, no state change &amp; no threads to wake</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(!</span><span class="n">AnyWaiters</span><span class="p">(</span><span class="n">desired</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">Free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="n">Debug</span><span class="p">.</span><span class="n">Assert</span><span class="p">(</span><span class="n">NumWritersWaiting</span><span class="p">(</span><span class="n">desired</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">SetState</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="n">OneManyLockStates</span><span class="p">.</span><span class="n">ReservedForWriter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">AddWritersWaiting</span><span class="p">(</span><span class="k">ref</span> <span class="n">desired</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">               <span class="n">wakeup</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>   <span class="c1">// Wake 1 writer</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="p">=</span> <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">target</span><span class="p">,</span> <span class="n">desired</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="p">!=</span> <span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">wakeup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="countdownevent类" class="heading-element"><span>CountdownEvent类</span>
  <a href="#countdownevent%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>内部使用MuanualResetEventSlim对象。</p>
<h4 id="barrier类" class="heading-element"><span>Barrier类</span>
  <a href="#barrier%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>该类型可以控制一系列线程需要并行工作。</p>
<p>这儿有一个例子将GC回收线程操作完整说了一遍。</p>
<h4 id="线程同步构造小结" class="heading-element"><span>线程同步构造小结</span>
  <a href="#%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5%e6%9e%84%e9%80%a0%e5%b0%8f%e7%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>以下两种情况阻塞线程</p>
<ul>
<li>线程模型很简单</li>
<li>线程有专门用途</li>
</ul>
<h3 id="著名的双检锁技术" class="heading-element"><span>著名的双检锁技术</span>
  <a href="#%e8%91%97%e5%90%8d%e7%9a%84%e5%8f%8c%e6%a3%80%e9%94%81%e6%8a%80%e6%9c%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>单实例，</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Singleton</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// s_lock is required for thread safety and having this object assumes that creating  </span>
</span></span><span class="line"><span class="cl">         <span class="c1">// the singleton object is more expensive than creating a System.Object object and that </span>
</span></span><span class="line"><span class="cl">         <span class="c1">// creating the singleton object may not be necessary at all. Otherwise, it is more  </span>
</span></span><span class="line"><span class="cl">         <span class="c1">// efficient and easier to just create the singleton object in a class constructor</span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="kd">static</span> <span class="k">readonly</span> <span class="n">Object</span> <span class="n">s_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// This field will refer to the one Singleton object</span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">s_value</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Private constructor prevents any code outside this class from creating an instance </span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="n">Singleton</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Public, static method that returns the Singleton object (creating it if necessary) </span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">GetSingleton</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// If the Singleton was already created, just return it (this is fast)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">s_value</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">s_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Enter</span><span class="p">(</span><span class="n">s_lock</span><span class="p">);</span>  <span class="c1">// Not created, let 1 thread create it</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">s_value</span> <span class="p">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="c1">// Still not created, create it</span>
</span></span><span class="line"><span class="cl">               <span class="n">Singleton</span> <span class="n">temp</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               <span class="c1">// Save the reference in s_value (see discussion for details)</span>
</span></span><span class="line"><span class="cl">               <span class="n">Volatile</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="k">ref</span> <span class="n">s_value</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">Monitor</span><span class="p">.</span><span class="n">Exit</span><span class="p">(</span><span class="n">s_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Return a reference to the one Singleton object </span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">s_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>简单版本相同效果，缺点在于访问任何成员都会调用类型构造器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">  <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Singleton</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">s_value</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// Private constructor prevents any code outside this class from creating an instance </span>
</span></span><span class="line"><span class="cl">     <span class="kd">private</span> <span class="n">Singleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1">// Public, static method that returns the Singleton object (creating it if necessary) </span>
</span></span><span class="line"><span class="cl">     <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">GetSingleton</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s_value</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第三种方法，这个版本有可能创建多个s_value；很小的几率</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c#" data-lang="c#"><span class="line"><span class="cl">      <span class="kd">public</span> <span class="kd">sealed</span> <span class="k">class</span> <span class="nc">Singleton</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">s_value</span> <span class="p">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Private constructor prevents any code outside this class from creating an instance </span>
</span></span><span class="line"><span class="cl">         <span class="kd">private</span> <span class="n">Singleton</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="c1">// Public, static method that returns the Singleton object (creating it if necessary) </span>
</span></span><span class="line"><span class="cl">         <span class="kd">public</span> <span class="kd">static</span> <span class="n">Singleton</span> <span class="n">GetSingleton</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">s_value</span> <span class="p">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">s_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Create a new Singleton and root it if another thread didn’t do it first</span>
</span></span><span class="line"><span class="cl">            <span class="n">Singleton</span> <span class="n">temp</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">Interlocked</span><span class="p">.</span><span class="n">CompareExchange</span><span class="p">(</span><span class="k">ref</span> <span class="n">s_value</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// If this thread lost, then the second Singleton object gets GC’d</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">s_value</span><span class="p">;</span> <span class="c1">// Return reference to the single object</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2020-03-01 17:09:22">更新于 2020-03-01&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0 转载请注明来源</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="https://github.com/DDuuuu/issues/new?title=[BUG]%20NetCLRVia&#43;%E5%90%8C%E6%AD%A5%E4%B8%8E%E7%AB%9E%E4%BA%89&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cNetCLRVia&#43;%E5%90%8C%E6%AD%A5%E4%B8%8E%E7%AB%9E%E4%BA%89%7c%0A%7cURL%7chttps://DDuuuu.github.io/2020/03/dotnetbase8-netclrvia/%7c%0A%7cFilename%7c%7c" title="报告问题"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">报告问题</a></span></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/netclrvia/" class="post-tag" title="标签 - NetCLRVia">NetCLRVia</a><a href="/tags/%E5%90%8C%E6%AD%A5%E4%B8%8E%E7%AB%9E%E4%BA%89/" class="post-tag" title="标签 - 同步与竞争">同步与竞争</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/2020/02/dotnetbase7-netclrvia/" class="post-nav-item" rel="prev" title="NetCLRVia 线程"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>NetCLRVia 线程</a>
      <a href="/2020/03/prism15-source/" class="post-nav-item" rel="next" title="Prism源码解析 Bootstrapper和Region的创建">Prism源码解析 Bootstrapper和Region的创建<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div class="post-reward">
    <div class="comment">为爱发电,请我喝杯咖啡吧</div>
    <input type="checkbox" class="reward-input" name="reward" id="fi-reward" hidden />
    <label class="reward-button" for="fi-reward"><i class="fa-solid fa-qrcode fa-fw" aria-hidden="true"></i>赞赏</label>
    <div class="reward-ways" data-mode="static"><div><img loading="lazy" src="/images/alipay.jpg" alt="AndrewDu 支付宝" data-title="AndrewDu 支付宝" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>支付宝</span>
          </div><div><img loading="lazy" src="/images/wechat.jpg" alt="AndrewDu 微信" data-title="AndrewDu 微信" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>微信</span>
          </div></div>
  </div><div id="comments"><div id="artalk" class="comment">
	  	 </div><script>
		  new Artalk({
			server:    'http:\/\/175.24.188.254:2240',
		  })
  </script>
      <noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/ArtalkJS/Artalk" rel="external nofollow noopener noreferrer">Artalk</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2018 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/DDuuuu"target="_blank" rel="external nofollow noopener noreferrer">AndrewDu</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="ms-1 d-none">网站运行时间:</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><a href="https://github.com/DDuuuu" title="AndrewDu GitHub"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;bottom: 0;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="http://175.24.188.254:2240/dist/Artalk.css"><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="https://polyfill.io/v3/polyfill.min.js?features=Array.prototype.fill%2CArray.prototype.find%2CArray.from%2CIntersectionObserver%2CMath.sign%2CObject.assign%2CPromise%2CObject.entries%2Chtml5shiv%2CObject.values%2Cfetch%2CElement.prototype.after"></script><script src="/lib/object-fit-images/ofi.min.js"></script><script src="http://175.24.188.254:2240/dist/Artalk.js"></script><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pangu/pangu.min.js" defer></script><script src="/lib/cell-watermark/watermark.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","maxShownLines":999999},"comment":{"artalk":{"countEl":"artalk-comment-count","editorTravel":true,"el":"#artalk","flatMode":"auto","gravatar":{"mirror":"https://www.gravatar.com/avatar/","params":"d=\u0026s=240"},"locale":"zh-CN","nestMax":2,"nestSort":"DATE_ASC","pageKey":"https://DDuuuu.github.io/2020/03/dotnetbase8-netclrvia/","pageTitle":"NetCLRVia 同步与竞争","pvEl":"artalk-visitor-count","server":"http://175.24.188.254:2240","site":"默认站点","useBackendConf":false},"enable":true,"expired":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"pangu":{"enable":true,"selector":"article"},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":12,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":100,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"siteTime":"2018-02-22T04:10:22+08:00","twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.8","watermark":{"colspacing":300,"content":"Andrew.Du","enable":true,"fontfamily":"inherit","fontsize":0.85,"height":20,"opacity":0.1,"rotate":15,"rowspacing":300,"width":150}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
